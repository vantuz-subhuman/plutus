<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE KindSignatures      #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE LiberalTypeSynonyms #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings   #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.PlutusCore.Constant.Dynamic.OnChain</span><span>
</span><a name="line-9"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChain"><span class="hs-identifier hs-type">OnChain</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainEvaluator"><span class="hs-identifier hs-type">OnChainEvaluator</span></a><span>
</span><a name="line-11"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainTransformer"><span class="hs-identifier hs-type">OnChainTransformer</span></a><span>
</span><a name="line-12"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainHandler"><span class="hs-identifier hs-type">OnChainHandler</span></a><span>
</span><a name="line-13"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#mangleOnChain"><span class="hs-identifier hs-var">mangleOnChain</span></a><span>
</span><a name="line-14"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#handleDynamicByMeaning"><span class="hs-identifier hs-var">handleDynamicByMeaning</span></a><span>
</span><a name="line-15"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#dynamicEmit"><span class="hs-identifier hs-var">dynamicEmit</span></a><span>
</span><a name="line-16"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#handleDynamicEmit"><span class="hs-identifier hs-var">handleDynamicEmit</span></a><span>
</span><a name="line-17"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#dynamicLog"><span class="hs-identifier hs-var">dynamicLog</span></a><span>
</span><a name="line-18"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#handleDynamicLog"><span class="hs-identifier hs-var">handleDynamicLog</span></a><span>
</span><a name="line-19"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#evaluateHandlersBy"><span class="hs-identifier hs-var">evaluateHandlersBy</span></a><span>
</span><a name="line-20"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Constant.Dynamic.Call.html"><span class="hs-identifier">Language.PlutusCore.Constant.Dynamic.Call</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Constant.Dynamic.Emit.html"><span class="hs-identifier">Language.PlutusCore.Constant.Dynamic.Emit</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Constant.Dynamic.Instances.html"><span class="hs-identifier">Language.PlutusCore.Constant.Dynamic.Instances</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Constant.Function.html"><span class="hs-identifier">Language.PlutusCore.Constant.Function</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Constant.Make.html"><span class="hs-identifier">Language.PlutusCore.Constant.Make</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Constant.Typed.html"><span class="hs-identifier">Language.PlutusCore.Constant.Typed</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Name.html"><span class="hs-identifier">Language.PlutusCore.Name</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Type.html"><span class="hs-identifier">Language.PlutusCore.Type</span></a><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Coerce</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Proxy</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text</span><span>                                      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Text</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.TypeLits</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-comment">{- Note [Interpretation of names]
The thing about dynamic built-in names is that they really can denote arbitrary effects.
This means we can't just initialize an evaluator with a 'DynamicBuiltinNameMeanings', because
some of these 'DynamicBuiltinNameMeaning's may be initializable in monads, some of them may call
effectful functions during evaluation (but we use 'unsafePerformIO' to handle this case for now),
but what's worse is that some of them may require finalization. This means we can't even pass a
@m DynamicBuiltinNameMeaning@ to an evaluator, we have to do something *after* evaluation finishes.
And of course the evaluator can't know everything we may want to do. In general, we want a way to
interpret dynamic built-in names in such a way that intepretation alters the process of evaluation.
Like if you want logging, then you need to open something to write logs in before evaluation starts
and to read the logs after evaluation finishes. But it is also the case that many dynamic built-in
names are perfectly pure, so we need an interface that allows to compose various kinds of handlers
of dynamic built-in names. And &quot;handler&quot; is a very right word, because what we do in this file is
very similar to how handlers of algebraic effects work.
-}</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-comment">{- Note [Names at the type-level]
Due to the fact that the interpretation of a dynamic built-in name is an arbitrary effect, we must know
beforehand names that a term contains, because the type of the result of evaluation depends on them.
An on-chain evaluator knows how to evaluate certain names, but terms are generated off-chain meaning
the on-chain evaluator and the off-chain generator must have consensus on which names what mean.
For this reason we index an on-chain term by a list of dynamic built-in names it can contain.
Any generator targeting a certain blockchain must produce terms indexed by names the blockchain is able
to evaluate.
-}</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-comment">-- Well that's ugly.</span><span>
</span><a name="line-64"></a><span class="hs-keyword">newtype</span><span> </span><a name="OnChain"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChain"><span class="hs-identifier">OnChain</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679552247"><a href="#local-6989586621679552247"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Symbol</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679552248"><a href="#local-6989586621679552248"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679552249"><a href="#local-6989586621679552249"><span class="hs-identifier">tyname</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-operator hs-type">*</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-operator hs-type">*</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679552250"><a href="#local-6989586621679552250"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-operator hs-type">*</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-operator hs-type">*</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679552251"><a href="#local-6989586621679552251"><span class="hs-identifier">ann</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="OnChain"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChain"><span class="hs-identifier">OnChain</span></a></a><span>
</span><a name="line-65"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="unOnChain"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#unOnChain"><span class="hs-identifier">unOnChain</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679552248"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552249"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679552250"><span class="hs-identifier hs-type">name</span></a><span> </span><a href="#local-6989586621679552251"><span class="hs-identifier hs-type">ann</span></a><span>
</span><a name="line-66"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">-- Does it make sense to unify this with 'Evaluator' somehow?</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- Is it really worth parameterizing this by 'f', so that is can be used over both</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- 'Term' and 'Program'? I imagine we can live with just 'Term'.</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- | The type of evaluators that run on-chain. This is very similar to 'Evaluator', except</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- an 'OnChainEvaluator' is allowed to return any @r@, not just a @m EvaluationResult@ for some @m@.</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- This is because an evaluator running on-chain can perform arbitrary effects and return an arbitrary</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- result containing an 'EvaluationResult' somewhere deep inside @r@.</span><span>
</span><a name="line-75"></a><span class="hs-keyword">type</span><span> </span><a name="OnChainEvaluator"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainEvaluator"><span class="hs-identifier">OnChainEvaluator</span></a></a><span> </span><a name="local-6989586621679552244"><a href="#local-6989586621679552244"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621679552245"><a href="#local-6989586621679552245"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679552246"><a href="#local-6989586621679552246"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-76"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameMeanings"><span class="hs-identifier hs-type">DynamicBuiltinNameMeanings</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChain"><span class="hs-identifier hs-type">OnChain</span></a><span> </span><a href="#local-6989586621679552244"><span class="hs-identifier hs-type">names</span></a><span> </span><a href="#local-6989586621679552245"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679552246"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- @f@ is shared, hence it does first.</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- | The type of functions that transform 'OnChainEvaluator's.</span><span>
</span><a name="line-80"></a><span class="hs-keyword">type</span><span> </span><a name="OnChainTransformer"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainTransformer"><span class="hs-identifier">OnChainTransformer</span></a></a><span> </span><a name="local-6989586621679552239"><a href="#local-6989586621679552239"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679552240"><a href="#local-6989586621679552240"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621679552241"><a href="#local-6989586621679552241"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679552242"><a href="#local-6989586621679552242"><span class="hs-identifier">names'</span></a></a><span> </span><a name="local-6989586621679552243"><a href="#local-6989586621679552243"><span class="hs-identifier">r'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-81"></a><span>    </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainEvaluator"><span class="hs-identifier hs-type">OnChainEvaluator</span></a><span> </span><a href="#local-6989586621679552240"><span class="hs-identifier hs-type">names</span></a><span> </span><a href="#local-6989586621679552239"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552241"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainEvaluator"><span class="hs-identifier hs-type">OnChainEvaluator</span></a><span> </span><a href="#local-6989586621679552242"><span class="hs-identifier hs-type">names'</span></a><span> </span><a href="#local-6989586621679552239"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552243"><span class="hs-identifier hs-type">r'</span></a><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">-- | The type of handlers of outermost dynamic built-in names.</span><span>
</span><a name="line-84"></a><span class="hs-keyword">type</span><span> </span><a name="OnChainHandler"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainHandler"><span class="hs-identifier">OnChainHandler</span></a></a><span> </span><a name="local-6989586621679552234"><a href="#local-6989586621679552234"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679552235"><a href="#local-6989586621679552235"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679552236"><a href="#local-6989586621679552236"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679552237"><a href="#local-6989586621679552237"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-85"></a><span>    </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679552238"><a href="#local-6989586621679552238"><span class="hs-identifier">names</span></a></a><span class="hs-operator">.</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainTransformer"><span class="hs-identifier hs-type">OnChainTransformer</span></a><span> </span><a href="#local-6989586621679552235"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552238"><span class="hs-identifier hs-type">names</span></a><span> </span><a href="#local-6989586621679552236"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">name</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679552238"><span class="hs-identifier hs-type">names</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679552237"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-identifier">mangleOnChain</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChain"><span class="hs-identifier hs-type">OnChain</span></a><span> </span><a href="#local-6989586621679552274"><span class="hs-identifier hs-type">names</span></a><span> </span><a href="#local-6989586621679552275"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552276"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679552277"><span class="hs-identifier hs-type">name</span></a><span> </span><a href="#local-6989586621679552278"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChain"><span class="hs-identifier hs-type">OnChain</span></a><span> </span><a href="#local-6989586621679552279"><span class="hs-identifier hs-type">names'</span></a><span> </span><a href="#local-6989586621679552275"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552276"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679552277"><span class="hs-identifier hs-type">name</span></a><span> </span><a href="#local-6989586621679552278"><span class="hs-identifier hs-type">ann</span></a><span>
</span><a name="line-88"></a><a name="mangleOnChain"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#mangleOnChain"><span class="hs-identifier">mangleOnChain</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coerce</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-comment">-- We should connect names with their meanings at the type level: @DynamicBuiltinNameMeaningOf name@.</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- Maybe we should even use dependent maps in abstract machines. Though, they are probably</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- not as optimized.</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- | Interpret a 'DynamicBuiltinNameMeaning' as an 'OnChainHandler' that doesn't change</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- the resulting type of evaluation.</span><span>
</span><a name="line-95"></a><span class="hs-identifier">handleDynamicByMeaning</span><span>
</span><a name="line-96"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679552271"><a href="#local-6989586621679552271"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679552272"><a href="#local-6989586621679552272"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679552273"><a href="#local-6989586621679552273"><span class="hs-identifier">r</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">KnownSymbol</span><span> </span><a href="#local-6989586621679552271"><span class="hs-identifier hs-type">name</span></a><span>
</span><a name="line-97"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameMeaning"><span class="hs-identifier hs-type">DynamicBuiltinNameMeaning</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainHandler"><span class="hs-identifier hs-type">OnChainHandler</span></a><span> </span><a href="#local-6989586621679552271"><span class="hs-identifier hs-type">name</span></a><span> </span><a href="#local-6989586621679552272"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552273"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="#local-6989586621679552273"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-98"></a><a name="handleDynamicByMeaning"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#handleDynamicByMeaning"><span class="hs-identifier">handleDynamicByMeaning</span></a></a><span> </span><a name="local-6989586621679552280"><a href="#local-6989586621679552280"><span class="hs-identifier">mean</span></a></a><span> </span><a name="local-6989586621679552281"><a href="#local-6989586621679552281"><span class="hs-identifier">eval</span></a></a><span> </span><a name="local-6989586621679552282"><a href="#local-6989586621679552282"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679552281"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679552285"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#mangleOnChain"><span class="hs-identifier hs-var">mangleOnChain</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-99"></a><span>    </span><a name="local-6989586621679552283"><a href="#local-6989586621679552283"><span class="hs-identifier">name</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Lexer.Type.html#DynamicBuiltinName"><span class="hs-identifier hs-var">DynamicBuiltinName</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Text.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">symbolVal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679552271"><span class="hs-identifier hs-type">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>    </span><a name="local-6989586621679552284"><a href="#local-6989586621679552284"><span class="hs-identifier">nameDef</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameDefinition"><span class="hs-identifier hs-var">DynamicBuiltinNameDefinition</span></a><span> </span><a href="#local-6989586621679552283"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679552280"><span class="hs-identifier hs-var">mean</span></a><span>
</span><a name="line-101"></a><span>    </span><a name="local-6989586621679552285"><a href="#local-6989586621679552285"><span class="hs-identifier">env'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Function.html#insertDynamicBuiltinNameDefinition"><span class="hs-identifier hs-var">insertDynamicBuiltinNameDefinition</span></a><span> </span><a href="#local-6989586621679552284"><span class="hs-identifier hs-var">nameDef</span></a><span> </span><a href="#local-6989586621679552282"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-identifier">handleDynamicEmitter</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679552266"><a href="#local-6989586621679552266"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679552267"><a href="#local-6989586621679552267"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679552268"><a href="#local-6989586621679552268"><span class="hs-identifier">r</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">KnownSymbol</span><span> </span><a href="#local-6989586621679552266"><span class="hs-identifier hs-type">name</span></a><span>
</span><a name="line-105"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainHandler"><span class="hs-identifier hs-type">OnChainHandler</span></a><span> </span><a href="#local-6989586621679552266"><span class="hs-identifier hs-type">name</span></a><span> </span><a href="#local-6989586621679552267"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552268"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679552269"><a href="#local-6989586621679552269"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679552270"><a href="#local-6989586621679552270"><span class="hs-identifier">size</span></a></a><span class="hs-operator">.</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier hs-type">TypedBuiltin</span></a><span> </span><a href="#local-6989586621679552270"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679552269"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621679552269"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679552268"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><a name="handleDynamicEmitter"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#handleDynamicEmitter"><span class="hs-identifier">handleDynamicEmitter</span></a></a><span> </span><a name="local-6989586621679552286"><a href="#local-6989586621679552286"><span class="hs-identifier">eval</span></a></a><span> </span><a name="local-6989586621679552287"><a href="#local-6989586621679552287"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679552288"><a href="#local-6989586621679552288"><span class="hs-identifier">term</span></a></a><span> </span><a name="local-6989586621679552289"><a href="#local-6989586621679552289"><span class="hs-identifier">tb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.Emit.html#withEmit"><span class="hs-identifier hs-var">withEmit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679552290"><a href="#local-6989586621679552290"><span class="hs-identifier">emit</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-107"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679552291"><a href="#local-6989586621679552291"><span class="hs-identifier">emitName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Lexer.Type.html#DynamicBuiltinName"><span class="hs-identifier hs-var">DynamicBuiltinName</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Text.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">symbolVal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679552266"><span class="hs-identifier hs-type">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>        </span><a name="local-6989586621679552292"><a href="#local-6989586621679552292"><span class="hs-identifier">emitDef</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.Call.html#dynamicCallAssign"><span class="hs-identifier hs-var">dynamicCallAssign</span></a><span> </span><a href="#local-6989586621679552289"><span class="hs-identifier hs-var">tb</span></a><span> </span><a href="#local-6989586621679552291"><span class="hs-identifier hs-var">emitName</span></a><span> </span><a href="#local-6989586621679552290"><span class="hs-identifier hs-var">emit</span></a><span>
</span><a name="line-109"></a><span>        </span><a name="local-6989586621679552293"><a href="#local-6989586621679552293"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Function.html#insertDynamicBuiltinNameDefinition"><span class="hs-identifier hs-var">insertDynamicBuiltinNameDefinition</span></a><span> </span><a href="#local-6989586621679552292"><span class="hs-identifier hs-var">emitDef</span></a><span> </span><a href="#local-6989586621679552287"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-110"></a><span>    </span><span class="hs-identifier hs-var">evaluate</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679552286"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679552293"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#mangleOnChain"><span class="hs-identifier hs-var">mangleOnChain</span></a><span> </span><a href="#local-6989586621679552288"><span class="hs-identifier hs-var">term</span></a><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-identifier">dynamicEmit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="#local-6989586621679552264"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679552265"><span class="hs-identifier hs-type">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><a name="dynamicEmit"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#dynamicEmit"><span class="hs-identifier">dynamicEmit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Make.html#dynamicBuiltinNameAsTerm"><span class="hs-identifier hs-var">dynamicBuiltinNameAsTerm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Lexer.Type.html#DynamicBuiltinName"><span class="hs-identifier hs-var">DynamicBuiltinName</span></a><span> </span><span class="hs-string">&quot;emit&quot;</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-identifier">handleDynamicEmit</span><span>
</span><a name="line-116"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainHandler"><span class="hs-identifier hs-type">OnChainHandler</span></a><span> </span><span class="hs-string">&quot;emit&quot;</span><span> </span><a href="#local-6989586621679552260"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552261"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679552262"><a href="#local-6989586621679552262"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679552263"><a href="#local-6989586621679552263"><span class="hs-identifier">size</span></a></a><span class="hs-operator">.</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier hs-type">TypedBuiltin</span></a><span> </span><a href="#local-6989586621679552263"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679552262"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621679552262"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679552261"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-117"></a><a name="handleDynamicEmit"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#handleDynamicEmit"><span class="hs-identifier">handleDynamicEmit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#handleDynamicEmitter"><span class="hs-identifier hs-var">handleDynamicEmitter</span></a><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-identifier">dynamicLog</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="#local-6989586621679552258"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679552259"><span class="hs-identifier hs-type">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><a name="dynamicLog"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#dynamicLog"><span class="hs-identifier">dynamicLog</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Make.html#dynamicBuiltinNameAsTerm"><span class="hs-identifier hs-var">dynamicBuiltinNameAsTerm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Lexer.Type.html#DynamicBuiltinName"><span class="hs-identifier hs-var">DynamicBuiltinName</span></a><span> </span><span class="hs-string">&quot;log&quot;</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-identifier">handleDynamicLog</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainHandler"><span class="hs-identifier hs-type">OnChainHandler</span></a><span> </span><span class="hs-string">&quot;log&quot;</span><span> </span><a href="#local-6989586621679552256"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552257"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679552257"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><a name="handleDynamicLog"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#handleDynamicLog"><span class="hs-identifier">handleDynamicLog</span></a></a><span> </span><a name="local-6989586621679552294"><a href="#local-6989586621679552294"><span class="hs-identifier">eval</span></a></a><span> </span><a name="local-6989586621679552295"><a href="#local-6989586621679552295"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679552296"><a href="#local-6989586621679552296"><span class="hs-identifier">term</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#handleDynamicEmitter"><span class="hs-identifier hs-var">handleDynamicEmitter</span></a><span> </span><a href="#local-6989586621679552294"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679552295"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679552296"><span class="hs-identifier hs-var">term</span></a><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinDyn"><span class="hs-identifier hs-var">TypedBuiltinDyn</span></a><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-identifier">evaluateHandlersBy</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#Evaluator"><span class="hs-identifier hs-type">Evaluator</span></a><span> </span><a href="#local-6989586621679552252"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552253"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-127"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#Evaluator"><span class="hs-identifier hs-type">Evaluator</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChain"><span class="hs-identifier hs-type">OnChain</span></a><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679552252"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679552253"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChainEvaluator"><span class="hs-identifier hs-type">OnChainEvaluator</span></a><span> </span><a href="#local-6989586621679552254"><span class="hs-identifier hs-type">names</span></a><span> </span><a href="#local-6989586621679552252"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679552255"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#OnChain"><span class="hs-identifier hs-type">OnChain</span></a><span> </span><a href="#local-6989586621679552254"><span class="hs-identifier hs-type">names</span></a><span> </span><a href="#local-6989586621679552252"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679552255"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-130"></a><a name="evaluateHandlersBy"><a href="Language.PlutusCore.Constant.Dynamic.OnChain.html#evaluateHandlersBy"><span class="hs-identifier">evaluateHandlersBy</span></a></a><span> </span><a name="local-6989586621679552297"><a href="#local-6989586621679552297"><span class="hs-identifier">eval</span></a></a><span> </span><a name="local-6989586621679552298"><a href="#local-6989586621679552298"><span class="hs-identifier">handlers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679552298"><span class="hs-identifier hs-var">handlers</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679552299"><a href="#local-6989586621679552299"><span class="hs-identifier">means</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679552297"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679552299"><span class="hs-identifier hs-var">means</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unOnChain</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-comment">-- We could have this class just to ensure that names are globally unique, but any instance</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- is necessary orphan which defeats the entire purpose.</span><span>
</span><a name="line-134"></a><span class="hs-comment">-- class GlobalBuiltinName (name :: Symbol) m | name -&gt; m where</span><span>
</span><a name="line-135"></a><span class="hs-comment">--     handleGlobalBuiltinNameM :: OnChainHandler f name r (m r)</span><span>
</span><a name="line-136"></a></pre></body></html>