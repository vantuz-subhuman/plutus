<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Normalization of PLC entities.</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-- Due to the generated 'normalizeEnvCountStep' below which is not used.</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-unused-top-binds #-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE DerivingStrategies #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell    #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.PlutusCore.Normalize</span><span>
</span><a name="line-10"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-type">NormalizeTypeT</span></a><span>
</span><a name="line-11"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Normalize.html#runNormalizeTypeM"><span class="hs-identifier hs-var">runNormalizeTypeM</span></a><span>
</span><a name="line-12"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Normalize.html#runNormalizeTypeDownM"><span class="hs-identifier hs-var">runNormalizeTypeDownM</span></a><span>
</span><a name="line-13"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Normalize.html#runNormalizeTypeGasM"><span class="hs-identifier hs-var">runNormalizeTypeGasM</span></a><span>
</span><a name="line-14"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Normalize.html#withExtendedTypeVarEnv"><span class="hs-identifier hs-var">withExtendedTypeVarEnv</span></a><span>
</span><a name="line-15"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span>
</span><a name="line-16"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeDown"><span class="hs-identifier hs-var">normalizeTypeDown</span></a><span>
</span><a name="line-17"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Normalize.html#substituteNormalizeTypeM"><span class="hs-identifier hs-var">substituteNormalizeTypeM</span></a><span>
</span><a name="line-18"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypesIn"><span class="hs-identifier hs-var">normalizeTypesIn</span></a><span>
</span><a name="line-19"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Name.html"><span class="hs-identifier">Language.PlutusCore.Name</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Quote.html"><span class="hs-identifier">Language.PlutusCore.Quote</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Renamer.html"><span class="hs-identifier">Language.PlutusCore.Renamer</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Type.html"><span class="hs-identifier">Language.PlutusCore.Type</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><a href="PlutusPrelude.html"><span class="hs-identifier">PlutusPrelude</span></a><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Lens</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Reader</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.State</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Trans.Maybe</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.IntMap</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntMap</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IntMap</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-comment">-- | Mapping from variables to what they stand for (each row represents a substitution).</span><span>
</span><a name="line-35"></a><span class="hs-comment">-- Needed for efficiency reasons, otherwise we could just use substitutions.</span><span>
</span><a name="line-36"></a><span class="hs-keyword">newtype</span><span> </span><a name="TypeVarEnv"><a href="Language.PlutusCore.Normalize.html#TypeVarEnv"><span class="hs-identifier">TypeVarEnv</span></a></a><span> </span><a name="local-6989586621679395108"><a href="#local-6989586621679395108"><span class="hs-identifier">tyname</span></a></a><span> </span><a name="local-6989586621679395109"><a href="#local-6989586621679395109"><span class="hs-identifier">ann</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TypeVarEnv"><a href="Language.PlutusCore.Normalize.html#TypeVarEnv"><span class="hs-identifier">TypeVarEnv</span></a></a><span>
</span><a name="line-37"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="unTypeVarEnv"><a href="Language.PlutusCore.Normalize.html#unTypeVarEnv"><span class="hs-identifier">unTypeVarEnv</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#NormalizedType"><span class="hs-identifier hs-type">NormalizedType</span></a><span> </span><a href="#local-6989586621679395108"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395109"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-comment">-- | The environments that type normalization runs in.</span><span>
</span><a name="line-41"></a><span class="hs-keyword">data</span><span> </span><a name="NormalizeTypeEnv"><a href="Language.PlutusCore.Normalize.html#NormalizeTypeEnv"><span class="hs-identifier">NormalizeTypeEnv</span></a></a><span> </span><a name="local-6989586621679395105"><a href="#local-6989586621679395105"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679395106"><a href="#local-6989586621679395106"><span class="hs-identifier">tyname</span></a></a><span> </span><a name="local-6989586621679395107"><a href="#local-6989586621679395107"><span class="hs-identifier">ann</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NormalizeTypeEnv"><a href="Language.PlutusCore.Normalize.html#NormalizeTypeEnv"><span class="hs-identifier">NormalizeTypeEnv</span></a></a><span>
</span><a name="line-42"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="_normalizeTypeEnvTypeVarEnv"><a href="Language.PlutusCore.Normalize.html#_normalizeTypeEnvTypeVarEnv"><span class="hs-identifier">_normalizeTypeEnvTypeVarEnv</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Normalize.html#TypeVarEnv"><span class="hs-identifier hs-type">TypeVarEnv</span></a><span> </span><a href="#local-6989586621679395106"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395107"><span class="hs-identifier hs-type">ann</span></a><span>
</span><a name="line-43"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="_normalizeTypeEnvCountStep"><a href="Language.PlutusCore.Normalize.html#_normalizeTypeEnvCountStep"><span class="hs-identifier">_normalizeTypeEnvCountStep</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679395105"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>      </span><span class="hs-comment">-- ^ How to count a type normalization step.</span><span>
</span><a name="line-45"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">NormalizeTypeEnv</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">{- Note [NormalizeTypeT]
Type normalization requires 'Quote' (because we need to be able to generate fresh names), but we
do not put 'Quote' into 'NormalizeTypeT'. The reason for this is that it makes type signatures of
various runners much nicer and also more generic. For example, we have

    runNormalizeTypeDownM :: MonadQuote m =&gt; NormalizeTypeT m tyname ann a -&gt; m a

If 'NormalizeTypeT' contained 'Quote', it would be

    runNormalizeTypeDownM :: NormalizeTypeT m tyname ann a -&gt; QuoteT m a

which hardcodes 'QuoteT' to be the outermost transformer.

Type normalization can run in any @m@ (as long as it's a 'MonadQuote') as witnessed by
the following type signature:

    normalizeTypeM
        :: (HasUnique (tyname ann) TypeUnique, MonadQuote m)
        =&gt; Type tyname ann -&gt; NormalizeTypeT m tyname ann (NormalizedType tyname ann)

so it's natural to have runners that do not break this genericity.
-}</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-comment">{- Note [Normalization API]
Normalization is split in two parts:

1. functions returning computations that perform reductions and run in defined in this module
   monad transformers (e.g. 'NormalizeTypeT')
2. runners of those computations

The reason for splitting the API is that this way the type-theoretic notion of normalization is
separated from implementation-specific details like how to count gas (we hardcode *where* to count
gas, but this can be generalized in case we need it). And this is important, because gas counting
requires access to different monads in different scenarios, so in the end we have a fine-grained API
instead of a single function that reflects all possible effects from distinct scenarios in its type
signature.
-}</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">-- See Note [NormalizedTypeT].</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- | The monad transformer that type normalization runs in.</span><span>
</span><a name="line-89"></a><span class="hs-keyword">newtype</span><span> </span><a name="NormalizeTypeT"><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier">NormalizeTypeT</span></a></a><span> </span><a name="local-6989586621679395212"><a href="#local-6989586621679395212"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679395213"><a href="#local-6989586621679395213"><span class="hs-identifier">tyname</span></a></a><span> </span><a name="local-6989586621679395214"><a href="#local-6989586621679395214"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395215"><a href="#local-6989586621679395215"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NormalizeTypeT"><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier">NormalizeTypeT</span></a></a><span>
</span><a name="line-90"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="unNormalizeTypeT"><a href="Language.PlutusCore.Normalize.html#unNormalizeTypeT"><span class="hs-identifier">unNormalizeTypeT</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeEnv"><span class="hs-identifier hs-type">NormalizeTypeEnv</span></a><span> </span><a href="#local-6989586621679395212"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395213"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395214"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679395212"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395215"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-91"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">newtype</span><span>
</span><a name="line-92"></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Alternative</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadPlus</span><span>
</span><a name="line-93"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadReader</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeEnv"><span class="hs-identifier hs-type">NormalizeTypeEnv</span></a><span> </span><a href="#local-6989586621679395212"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395213"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395214"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadState</span><span> </span><a href="#local-6989586621679395216"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-94"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Quote.html#MonadQuote"><span class="hs-identifier hs-type">MonadQuote</span></a><span>
</span><a name="line-95"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-comment">-- | Run a 'NormalizeTypeM' computation.</span><span>
</span><a name="line-98"></a><span class="hs-identifier">runNormalizeTypeM</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679395251"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-type">NormalizeTypeT</span></a><span> </span><a href="#local-6989586621679395251"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395252"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395253"><span class="hs-identifier hs-type">ann</span></a><span> </span><a href="#local-6989586621679395254"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679395251"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395254"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-99"></a><a name="runNormalizeTypeM"><a href="Language.PlutusCore.Normalize.html#runNormalizeTypeM"><span class="hs-identifier">runNormalizeTypeM</span></a></a><span> </span><a name="local-6989586621679395255"><a href="#local-6989586621679395255"><span class="hs-identifier">countStep</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-var">NormalizeTypeT</span></a><span> </span><a name="local-6989586621679395256"><a href="#local-6989586621679395256"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679395256"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeEnv"><span class="hs-identifier hs-var">NormalizeTypeEnv</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Normalize.html#TypeVarEnv"><span class="hs-identifier hs-var">TypeVarEnv</span></a><span> </span><span class="hs-identifier hs-var">mempty</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679395255"><span class="hs-identifier hs-var">countStep</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- | Run a 'NormalizeTypeM' computation without dealing with gas.</span><span>
</span><a name="line-103"></a><span class="hs-identifier">runNormalizeTypeDownM</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Quote.html#MonadQuote"><span class="hs-identifier hs-type">MonadQuote</span></a><span> </span><a href="#local-6989586621679395247"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-type">NormalizeTypeT</span></a><span> </span><a href="#local-6989586621679395247"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395248"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395249"><span class="hs-identifier hs-type">ann</span></a><span> </span><a href="#local-6989586621679395250"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679395247"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395250"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-105"></a><a name="runNormalizeTypeDownM"><a href="Language.PlutusCore.Normalize.html#runNormalizeTypeDownM"><span class="hs-identifier">runNormalizeTypeDownM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Normalize.html#runNormalizeTypeM"><span class="hs-identifier hs-var">runNormalizeTypeM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">-- | Run a gas-consuming 'NormalizeTypeM' computation.</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- Count a single substitution step by subtracting @1@ from available gas or</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- fail when there is no available gas.</span><span>
</span><a name="line-110"></a><span class="hs-identifier">runNormalizeTypeGasM</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Quote.html#MonadQuote"><span class="hs-identifier hs-type">MonadQuote</span></a><span> </span><a href="#local-6989586621679395243"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Type.html#Gas"><span class="hs-identifier hs-type">Gas</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-type">NormalizeTypeT</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StateT</span><span> </span><a href="Language.PlutusCore.Type.html#Gas"><span class="hs-identifier hs-type">Gas</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeT</span><span> </span><a href="#local-6989586621679395243"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679395244"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395245"><span class="hs-identifier hs-type">ann</span></a><span> </span><a href="#local-6989586621679395246"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679395243"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679395246"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-112"></a><a name="runNormalizeTypeGasM"><a href="Language.PlutusCore.Normalize.html#runNormalizeTypeGasM"><span class="hs-identifier">runNormalizeTypeGasM</span></a></a><span> </span><a name="local-6989586621679395257"><a href="#local-6989586621679395257"><span class="hs-identifier">gas</span></a></a><span> </span><a name="local-6989586621679395258"><a href="#local-6989586621679395258"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runMaybeT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">evalStateT</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Normalize.html#runNormalizeTypeM"><span class="hs-identifier hs-var">runNormalizeTypeM</span></a><span> </span><a href="#local-6989586621679395259"><span class="hs-identifier hs-var">countSubst</span></a><span> </span><a href="#local-6989586621679395258"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679395257"><span class="hs-identifier hs-var">gas</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-113"></a><span>    </span><a name="local-6989586621679395259"><a href="#local-6989586621679395259"><span class="hs-identifier">countSubst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-114"></a><span>        </span><a href="Language.PlutusCore.Type.html#Gas"><span class="hs-identifier hs-var">Gas</span></a><span> </span><a name="local-6989586621679395260"><a href="#local-6989586621679395260"><span class="hs-identifier">gas'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-115"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679395260"><span class="hs-identifier hs-var">gas'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-116"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">mzero</span><span>
</span><a name="line-117"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">put</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusCore.Type.html#Gas"><span class="hs-identifier hs-var">Gas</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679395260"><span class="hs-identifier hs-var">gas'</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-identifier">countTypeNormalizationStep</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-type">NormalizeTypeT</span></a><span> </span><a href="#local-6989586621679395240"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395241"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395242"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><a name="countTypeNormalizationStep"><a href="Language.PlutusCore.Normalize.html#countTypeNormalizationStep"><span class="hs-identifier">countTypeNormalizationStep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-var">NormalizeTypeT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">_normalizeTypeEnvCountStep</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-comment">-- | Locally extend a 'TypeVarEnv' in a 'NormalizeTypeM' computation.</span><span>
</span><a name="line-123"></a><span class="hs-identifier">withExtendedTypeVarEnv</span><span>
</span><a name="line-124"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679395236"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395237"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679395238"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679395236"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395237"><span class="hs-identifier hs-type">ann</span></a><span>
</span><a name="line-126"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Type.html#NormalizedType"><span class="hs-identifier hs-type">NormalizedType</span></a><span> </span><a href="#local-6989586621679395236"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395237"><span class="hs-identifier hs-type">ann</span></a><span>
</span><a name="line-127"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-type">NormalizeTypeT</span></a><span> </span><a href="#local-6989586621679395238"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395236"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395237"><span class="hs-identifier hs-type">ann</span></a><span> </span><a href="#local-6989586621679395239"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-128"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-type">NormalizeTypeT</span></a><span> </span><a href="#local-6989586621679395238"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395236"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395237"><span class="hs-identifier hs-type">ann</span></a><span> </span><a href="#local-6989586621679395239"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-129"></a><a name="withExtendedTypeVarEnv"><a href="Language.PlutusCore.Normalize.html#withExtendedTypeVarEnv"><span class="hs-identifier">withExtendedTypeVarEnv</span></a></a><span> </span><a name="local-6989586621679395261"><a href="#local-6989586621679395261"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679395262"><a href="#local-6989586621679395262"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-130"></a><span>    </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">over</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Normalize.html#normalizeTypeEnvTypeVarEnv"><span class="hs-identifier hs-var">normalizeTypeEnvTypeVarEnv</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">coerced</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-131"></a><span>        </span><span class="hs-identifier hs-var">IntMap.insert</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679395261"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Language.PlutusCore.Name.html#unique"><span class="hs-identifier hs-var">unique</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">coerced</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679395262"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-comment">-- | Look up a @tyname@ in a 'TypeVarEnv'.</span><span>
</span><a name="line-134"></a><span class="hs-identifier">lookupTyName</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679395233"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395234"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679395235"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679395233"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395234"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-type">NormalizeTypeT</span></a><span> </span><a href="#local-6989586621679395235"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395233"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395234"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#NormalizedType"><span class="hs-identifier hs-type">NormalizedType</span></a><span> </span><a href="#local-6989586621679395233"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395234"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-137"></a><a name="lookupTyName"><a href="Language.PlutusCore.Normalize.html#lookupTyName"><span class="hs-identifier">lookupTyName</span></a></a><span> </span><a name="local-6989586621679395263"><a href="#local-6989586621679395263"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">IntMap.lookup</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679395263"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Language.PlutusCore.Name.html#unique"><span class="hs-identifier hs-var">unique</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">coerced</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unTypeVarEnv</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">_normalizeTypeEnvTypeVarEnv</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-comment">{- Note [Normalization]
Normalization works under the assumption that variables are globally unique.
We use environments instead of substitutions as they're more efficient.

Since all names are unique and there is no need to track scopes, type normalization has only two
interesting cases: function application and a variable usage. In the function application case we
normalize a function and its argument, add the normalized argument to the environment and continue
normalization. In the variable case we look up the variable in the current environment: if it's not
found, we leave the variable untouched. If the variable is found, then what this variable stands for
was previously added to an environment (while handling the function application case), so we pick
this value and rename all bound variables in it to preserve the global uniqueness condition. It is
safe to do so, because picked values cannot contain uninstantiated variables as only normalized types
are added to environments and normalization instantiates all variables presented in an environment.
-}</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-comment">-- See Note [Normalization].</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- | Normalize a 'Type' in the 'NormalizeTypeM' monad.</span><span>
</span><a name="line-157"></a><span class="hs-identifier">normalizeTypeM</span><span>
</span><a name="line-158"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679395230"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395231"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Quote.html#MonadQuote"><span class="hs-identifier hs-type">MonadQuote</span></a><span> </span><a href="#local-6989586621679395232"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="#local-6989586621679395230"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395231"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-type">NormalizeTypeT</span></a><span> </span><a href="#local-6989586621679395232"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395230"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395231"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#NormalizedType"><span class="hs-identifier hs-type">NormalizedType</span></a><span> </span><a href="#local-6989586621679395230"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395231"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><a name="normalizeTypeM"><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier">normalizeTypeM</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#TyForall"><span class="hs-identifier hs-var">TyForall</span></a><span> </span><a name="local-6989586621679395264"><a href="#local-6989586621679395264"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395265"><a href="#local-6989586621679395265"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679395266"><a href="#local-6989586621679395266"><span class="hs-identifier">kind</span></a></a><span> </span><a name="local-6989586621679395267"><a href="#local-6989586621679395267"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-161"></a><span>    </span><a href="Language.PlutusCore.Type.html#TyForall"><span class="hs-identifier hs-var">TyForall</span></a><span> </span><a href="#local-6989586621679395264"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="#local-6989586621679395265"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679395266"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="PlutusPrelude.html#%3C%3C%24%3E%3E"><span class="hs-operator hs-var">&lt;&lt;$&gt;&gt;</span></a><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span> </span><a href="#local-6989586621679395267"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-162"></a><span class="hs-identifier">normalizeTypeM</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#TyIFix"><span class="hs-identifier hs-var">TyIFix</span></a><span> </span><a name="local-6989586621679395268"><a href="#local-6989586621679395268"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395269"><a href="#local-6989586621679395269"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621679395270"><a href="#local-6989586621679395270"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span>
</span><a name="line-163"></a><span>    </span><a href="Language.PlutusCore.Type.html#TyIFix"><span class="hs-identifier hs-var">TyIFix</span></a><span> </span><a href="#local-6989586621679395268"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="PlutusPrelude.html#%3C%3C%24%3E%3E"><span class="hs-operator hs-var">&lt;&lt;$&gt;&gt;</span></a><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span> </span><a href="#local-6989586621679395269"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="PlutusPrelude.html#%3C%3C%2A%3E%3E"><span class="hs-operator hs-var">&lt;&lt;*&gt;&gt;</span></a><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span> </span><a href="#local-6989586621679395270"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-164"></a><span class="hs-identifier">normalizeTypeM</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#TyFun"><span class="hs-identifier hs-var">TyFun</span></a><span> </span><a name="local-6989586621679395271"><a href="#local-6989586621679395271"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395272"><a href="#local-6989586621679395272"><span class="hs-identifier">dom</span></a></a><span> </span><a name="local-6989586621679395273"><a href="#local-6989586621679395273"><span class="hs-identifier">cod</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span>
</span><a name="line-165"></a><span>    </span><a href="Language.PlutusCore.Type.html#TyFun"><span class="hs-identifier hs-var">TyFun</span></a><span> </span><a href="#local-6989586621679395271"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="PlutusPrelude.html#%3C%3C%24%3E%3E"><span class="hs-operator hs-var">&lt;&lt;$&gt;&gt;</span></a><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span> </span><a href="#local-6989586621679395272"><span class="hs-identifier hs-var">dom</span></a><span> </span><a href="PlutusPrelude.html#%3C%3C%2A%3E%3E"><span class="hs-operator hs-var">&lt;&lt;*&gt;&gt;</span></a><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span> </span><a href="#local-6989586621679395273"><span class="hs-identifier hs-var">cod</span></a><span>
</span><a name="line-166"></a><span class="hs-identifier">normalizeTypeM</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#TyLam"><span class="hs-identifier hs-var">TyLam</span></a><span> </span><a name="local-6989586621679395274"><a href="#local-6989586621679395274"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395275"><a href="#local-6989586621679395275"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679395276"><a href="#local-6989586621679395276"><span class="hs-identifier">kind</span></a></a><span> </span><a name="local-6989586621679395277"><a href="#local-6989586621679395277"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span>
</span><a name="line-167"></a><span>    </span><a href="Language.PlutusCore.Type.html#TyLam"><span class="hs-identifier hs-var">TyLam</span></a><span> </span><a href="#local-6989586621679395274"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="#local-6989586621679395275"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679395276"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="PlutusPrelude.html#%3C%3C%24%3E%3E"><span class="hs-operator hs-var">&lt;&lt;$&gt;&gt;</span></a><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span> </span><a href="#local-6989586621679395277"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-168"></a><span class="hs-identifier">normalizeTypeM</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#TyApp"><span class="hs-identifier hs-var">TyApp</span></a><span> </span><a name="local-6989586621679395278"><a href="#local-6989586621679395278"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395279"><a href="#local-6989586621679395279"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679395280"><a href="#local-6989586621679395280"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-169"></a><span>    </span><a name="local-6989586621679395281"><a href="#local-6989586621679395281"><span class="hs-identifier">vFun</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span> </span><a href="#local-6989586621679395279"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-170"></a><span>    </span><a name="local-6989586621679395282"><a href="#local-6989586621679395282"><span class="hs-identifier">vArg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span> </span><a href="#local-6989586621679395280"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-171"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Language.PlutusCore.Type.html#getNormalizedType"><span class="hs-identifier hs-var">getNormalizedType</span></a><span> </span><a href="#local-6989586621679395281"><span class="hs-identifier hs-var">vFun</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-172"></a><span>        </span><a href="Language.PlutusCore.Type.html#TyLam"><span class="hs-identifier hs-var">TyLam</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679395283"><a href="#local-6989586621679395283"><span class="hs-identifier">nArg</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679395284"><a href="#local-6989586621679395284"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-173"></a><span>            </span><a href="Language.PlutusCore.Normalize.html#countTypeNormalizationStep"><span class="hs-identifier hs-var">countTypeNormalizationStep</span></a><span>
</span><a name="line-174"></a><span>            </span><a href="Language.PlutusCore.Normalize.html#substituteNormalizeTypeM"><span class="hs-identifier hs-var">substituteNormalizeTypeM</span></a><span> </span><a href="#local-6989586621679395282"><span class="hs-identifier hs-var">vArg</span></a><span> </span><a href="#local-6989586621679395283"><span class="hs-identifier hs-var">nArg</span></a><span> </span><a href="#local-6989586621679395284"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-175"></a><span>        </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Type.html#TyApp"><span class="hs-identifier hs-var">TyApp</span></a><span> </span><a href="#local-6989586621679395278"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679395281"><span class="hs-identifier hs-var">vFun</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679395282"><span class="hs-identifier hs-var">vArg</span></a><span>
</span><a name="line-176"></a><span class="hs-identifier">normalizeTypeM</span><span> </span><a name="local-6989586621679395285"><a href="#local-6989586621679395285"><span class="hs-identifier">var</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#TyVar"><span class="hs-identifier hs-var">TyVar</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679395286"><a href="#local-6989586621679395286"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-177"></a><span>    </span><a name="local-6989586621679395287"><a href="#local-6989586621679395287"><span class="hs-identifier">mayTy</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusCore.Normalize.html#lookupTyName"><span class="hs-identifier hs-var">lookupTyName</span></a><span> </span><a href="#local-6989586621679395286"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-178"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679395287"><span class="hs-identifier hs-var">mayTy</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-179"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Type.html#NormalizedType"><span class="hs-identifier hs-var">NormalizedType</span></a><span> </span><a href="#local-6989586621679395285"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-180"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679395288"><a href="#local-6989586621679395288"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="Language.PlutusCore.Renamer.html#rename"><span class="hs-identifier hs-var">rename</span></a><span> </span><a href="#local-6989586621679395288"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-181"></a><span class="hs-identifier">normalizeTypeM</span><span> </span><a name="local-6989586621679395289"><a href="#local-6989586621679395289"><span class="hs-identifier">size</span></a></a><span class="hs-glyph">@</span><a href="Language.PlutusCore.Type.html#TyInt"><span class="hs-identifier hs-var">TyInt</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>                  </span><span class="hs-glyph">=</span><span>
</span><a name="line-182"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Type.html#NormalizedType"><span class="hs-identifier hs-var">NormalizedType</span></a><span> </span><a href="#local-6989586621679395289"><span class="hs-identifier hs-var">size</span></a><span>
</span><a name="line-183"></a><span class="hs-identifier">normalizeTypeM</span><span> </span><a name="local-6989586621679395290"><a href="#local-6989586621679395290"><span class="hs-identifier">builtin</span></a></a><span class="hs-glyph">@</span><a href="Language.PlutusCore.Type.html#TyBuiltin"><span class="hs-identifier hs-var">TyBuiltin</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>           </span><span class="hs-glyph">=</span><span>
</span><a name="line-184"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Type.html#NormalizedType"><span class="hs-identifier hs-var">NormalizedType</span></a><span> </span><a href="#local-6989586621679395290"><span class="hs-identifier hs-var">builtin</span></a><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-comment">{- Note [Normalizing substitution]
@substituteNormalize[M]@ is only ever used as normalizing substitution that receives two already
normalized types. However we do not enforce this in the type signature, because
1) it's perfectly correct for the last argument to be non-normalized
2) it would be annoying to wrap 'Type's into 'NormalizedType's
-}</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">-- See Note [Normalizing substitution].</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- | Substitute a type for a variable in a type and normalize in the 'NormalizeTypeM' monad.</span><span>
</span><a name="line-195"></a><span class="hs-identifier">substituteNormalizeTypeM</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679395227"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395228"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Quote.html#MonadQuote"><span class="hs-identifier hs-type">MonadQuote</span></a><span> </span><a href="#local-6989586621679395229"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Type.html#NormalizedType"><span class="hs-identifier hs-type">NormalizedType</span></a><span> </span><a href="#local-6989586621679395227"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395228"><span class="hs-identifier hs-type">ann</span></a><span>                                </span><span class="hs-comment">-- ^ @ty@</span><span>
</span><a name="line-198"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679395227"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395228"><span class="hs-identifier hs-type">ann</span></a><span>                                               </span><span class="hs-comment">-- ^ @name@</span><span>
</span><a name="line-199"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="#local-6989586621679395227"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395228"><span class="hs-identifier hs-type">ann</span></a><span>                                          </span><span class="hs-comment">-- ^ @body@</span><span>
</span><a name="line-200"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-type">NormalizeTypeT</span></a><span> </span><a href="#local-6989586621679395229"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395227"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395228"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#NormalizedType"><span class="hs-identifier hs-type">NormalizedType</span></a><span> </span><a href="#local-6989586621679395227"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395228"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ @NORM ([ty / name] body)@</span><span>
</span><a name="line-201"></a><a name="substituteNormalizeTypeM"><a href="Language.PlutusCore.Normalize.html#substituteNormalizeTypeM"><span class="hs-identifier">substituteNormalizeTypeM</span></a></a><span> </span><a name="local-6989586621679395291"><a href="#local-6989586621679395291"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621679395292"><a href="#local-6989586621679395292"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Normalize.html#withExtendedTypeVarEnv"><span class="hs-identifier hs-var">withExtendedTypeVarEnv</span></a><span> </span><a href="#local-6989586621679395292"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679395291"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span class="hs-comment">-- See Note [Normalization].</span><span>
</span><a name="line-204"></a><span class="hs-comment">-- | Normalize a 'Type'.</span><span>
</span><a name="line-205"></a><span class="hs-identifier">normalizeType</span><span>
</span><a name="line-206"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679395224"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395225"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Quote.html#MonadQuote"><span class="hs-identifier hs-type">MonadQuote</span></a><span> </span><a href="#local-6989586621679395226"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-207"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679395226"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="#local-6989586621679395224"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395225"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679395226"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#NormalizedType"><span class="hs-identifier hs-type">NormalizedType</span></a><span> </span><a href="#local-6989586621679395224"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395225"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><a name="normalizeType"><a href="Language.PlutusCore.Normalize.html#normalizeType"><span class="hs-identifier">normalizeType</span></a></a><span> </span><a name="local-6989586621679395293"><a href="#local-6989586621679395293"><span class="hs-identifier">countStep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Normalize.html#runNormalizeTypeM"><span class="hs-identifier hs-var">runNormalizeTypeM</span></a><span> </span><a href="#local-6989586621679395293"><span class="hs-identifier hs-var">countStep</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-comment">-- See Note [Normalization].</span><span>
</span><a name="line-211"></a><span class="hs-comment">--- | Normalize a 'Type' without dealing with gas.</span><span>
</span><a name="line-212"></a><span class="hs-identifier">normalizeTypeDown</span><span>
</span><a name="line-213"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679395221"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395222"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Quote.html#MonadQuote"><span class="hs-identifier hs-type">MonadQuote</span></a><span> </span><a href="#local-6989586621679395223"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="#local-6989586621679395221"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395222"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679395223"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#NormalizedType"><span class="hs-identifier hs-type">NormalizedType</span></a><span> </span><a href="#local-6989586621679395221"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395222"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><a name="normalizeTypeDown"><a href="Language.PlutusCore.Normalize.html#normalizeTypeDown"><span class="hs-identifier">normalizeTypeDown</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeType"><span class="hs-identifier hs-var">normalizeType</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-comment">-- | Normalize every 'Type' in a 'Term'.</span><span>
</span><a name="line-218"></a><span class="hs-identifier">normalizeTypesIn</span><span>
</span><a name="line-219"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679395217"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395218"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Quote.html#MonadQuote"><span class="hs-identifier hs-type">MonadQuote</span></a><span> </span><a href="#local-6989586621679395219"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="#local-6989586621679395217"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395220"><span class="hs-identifier hs-type">name</span></a><span> </span><a href="#local-6989586621679395218"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Normalize.html#NormalizeTypeT"><span class="hs-identifier hs-type">NormalizeTypeT</span></a><span> </span><a href="#local-6989586621679395219"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679395217"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395218"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="#local-6989586621679395217"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679395220"><span class="hs-identifier hs-type">name</span></a><span> </span><a href="#local-6989586621679395218"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><a name="normalizeTypesIn"><a href="Language.PlutusCore.Normalize.html#normalizeTypesIn"><span class="hs-identifier">normalizeTypesIn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679395295"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-222"></a><span>    </span><span class="hs-comment">-- | Normalize a 'Type' and return the result as a 'Type' (as opposed to 'NormalizedType').</span><span>
</span><a name="line-223"></a><span>    </span><a name="local-6989586621679395294"><a href="#local-6989586621679395294"><span class="hs-identifier">normalizeReturnType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Language.PlutusCore.Type.html#getNormalizedType"><span class="hs-identifier hs-var">getNormalizedType</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusCore.Normalize.html#normalizeTypeM"><span class="hs-identifier hs-var">normalizeTypeM</span></a><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span>    </span><a name="local-6989586621679395295"><a href="#local-6989586621679395295"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a><span> </span><a name="local-6989586621679395296"><a href="#local-6989586621679395296"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395297"><a href="#local-6989586621679395297"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679395298"><a href="#local-6989586621679395298"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621679395299"><a href="#local-6989586621679395299"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Type.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a><span> </span><a href="#local-6989586621679395296"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="#local-6989586621679395297"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679395294"><span class="hs-identifier hs-var">normalizeReturnType</span></a><span> </span><a href="#local-6989586621679395298"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679395295"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679395299"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-226"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#TyAbs"><span class="hs-identifier hs-var">TyAbs</span></a><span> </span><a name="local-6989586621679395300"><a href="#local-6989586621679395300"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395301"><a href="#local-6989586621679395301"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679395302"><a href="#local-6989586621679395302"><span class="hs-identifier">kind</span></a></a><span> </span><a name="local-6989586621679395303"><a href="#local-6989586621679395303"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Type.html#TyAbs"><span class="hs-identifier hs-var">TyAbs</span></a><span> </span><a href="#local-6989586621679395300"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="#local-6989586621679395301"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679395302"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679395295"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679395303"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-227"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#IWrap"><span class="hs-identifier hs-var">IWrap</span></a><span> </span><a name="local-6989586621679395304"><a href="#local-6989586621679395304"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395305"><a href="#local-6989586621679395305"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621679395306"><a href="#local-6989586621679395306"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621679395307"><a href="#local-6989586621679395307"><span class="hs-identifier">term</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span>
</span><a name="line-228"></a><span>        </span><a href="Language.PlutusCore.Type.html#IWrap"><span class="hs-identifier hs-var">IWrap</span></a><span> </span><a href="#local-6989586621679395304"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679395294"><span class="hs-identifier hs-var">normalizeReturnType</span></a><span> </span><a href="#local-6989586621679395305"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679395294"><span class="hs-identifier hs-var">normalizeReturnType</span></a><span> </span><a href="#local-6989586621679395306"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679395295"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679395307"><span class="hs-identifier hs-var">term</span></a><span>
</span><a name="line-229"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span> </span><a name="local-6989586621679395308"><a href="#local-6989586621679395308"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395309"><a href="#local-6989586621679395309"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679395310"><a href="#local-6989586621679395310"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Type.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span> </span><a href="#local-6989586621679395308"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679395295"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679395309"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679395295"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679395310"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-230"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Unwrap"><span class="hs-identifier hs-var">Unwrap</span></a><span> </span><a name="local-6989586621679395311"><a href="#local-6989586621679395311"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395312"><a href="#local-6989586621679395312"><span class="hs-identifier">term</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Type.html#Unwrap"><span class="hs-identifier hs-var">Unwrap</span></a><span> </span><a href="#local-6989586621679395311"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679395295"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679395312"><span class="hs-identifier hs-var">term</span></a><span>
</span><a name="line-231"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a name="local-6989586621679395313"><a href="#local-6989586621679395313"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395314"><a href="#local-6989586621679395314"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Type.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a href="#local-6989586621679395313"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679395294"><span class="hs-identifier hs-var">normalizeReturnType</span></a><span> </span><a href="#local-6989586621679395314"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-232"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#TyInst"><span class="hs-identifier hs-var">TyInst</span></a><span> </span><a name="local-6989586621679395315"><a href="#local-6989586621679395315"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395316"><a href="#local-6989586621679395316"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621679395317"><a href="#local-6989586621679395317"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Type.html#TyInst"><span class="hs-identifier hs-var">TyInst</span></a><span> </span><a href="#local-6989586621679395315"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679395295"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679395316"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679395294"><span class="hs-identifier hs-var">normalizeReturnType</span></a><span> </span><a href="#local-6989586621679395317"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-233"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621679395318"><a href="#local-6989586621679395318"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679395319"><a href="#local-6989586621679395319"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Type.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621679395318"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="#local-6989586621679395319"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-234"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679395320"><a href="#local-6989586621679395320"><span class="hs-identifier">con</span></a></a><span class="hs-glyph">@</span><a href="Language.PlutusCore.Type.html#Constant"><span class="hs-identifier hs-var">Constant</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679395320"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-235"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679395321"><a href="#local-6989586621679395321"><span class="hs-identifier">bi</span></a></a><span class="hs-glyph">@</span><a href="Language.PlutusCore.Type.html#Builtin"><span class="hs-identifier hs-var">Builtin</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679395321"><span class="hs-identifier hs-var">bi</span></a><span>
</span><a name="line-236"></a></pre></body></html>