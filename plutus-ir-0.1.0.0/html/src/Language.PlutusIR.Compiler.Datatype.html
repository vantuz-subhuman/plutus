<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications  #-}</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- | Functions for compiling let-bound PIR datatypes into PLC.</span><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.PlutusIR.Compiler.Datatype</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Datatype.html#compileDatatype"><span class="hs-identifier hs-var">compileDatatype</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">PlutusPrelude</span><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showText</span><span class="hs-special">)</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusIR.html"><span class="hs-identifier">Language.PlutusIR</span></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusIR.Compiler.Names.html"><span class="hs-identifier">Language.PlutusIR.Compiler.Names</span></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusIR.Compiler.Provenance.html"><span class="hs-identifier">Language.PlutusIR.Compiler.Provenance</span></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusIR.Compiler.Types.html"><span class="hs-identifier">Language.PlutusIR.Compiler.Types</span></a><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusCore</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PLC</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusCore.MkPlc</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PLC</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.PlutusCore.Quote</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusCore.StdLib.Type</span><span>       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Types</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusCore.Subst</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PLC</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Reader</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text</span><span>                             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Traversable</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-comment">-- Utilities</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-comment">-- | @replaceFunTyTarget X (A-&gt;..-&gt;Z) = (A-&gt;..-&gt;X)@</span><span>
</span><a name="line-28"></a><span class="hs-identifier">replaceFunTyTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PLC.Type</span><span> </span><a href="#local-6989586621679186618"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186619"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PLC.Type</span><span> </span><a href="#local-6989586621679186618"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186619"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PLC.Type</span><span> </span><a href="#local-6989586621679186618"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186619"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-29"></a><a name="replaceFunTyTarget"><a href="Language.PlutusIR.Compiler.Datatype.html#replaceFunTyTarget"><span class="hs-identifier">replaceFunTyTarget</span></a></a><span> </span><a name="local-6989586621679186620"><a href="#local-6989586621679186620"><span class="hs-identifier">newTarget</span></a></a><span> </span><a name="local-6989586621679186621"><a href="#local-6989586621679186621"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679186621"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-30"></a><span>    </span><span class="hs-identifier hs-var">PLC.TyFun</span><span> </span><a name="local-6989586621679186622"><a href="#local-6989586621679186622"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679186623"><a href="#local-6989586621679186623"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621679186624"><a href="#local-6989586621679186624"><span class="hs-identifier">t2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">PLC.TyFun</span><span> </span><a href="#local-6989586621679186622"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679186623"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#replaceFunTyTarget"><span class="hs-identifier hs-var">replaceFunTyTarget</span></a><span> </span><a href="#local-6989586621679186620"><span class="hs-identifier hs-var">newTarget</span></a><span> </span><a href="#local-6989586621679186624"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-31"></a><span>    </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679186620"><span class="hs-identifier hs-var">newTarget</span></a><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-comment">-- | Given the type of a constructor, get the type of the &quot;case&quot; type with the given result type.</span><span>
</span><a name="line-34"></a><span class="hs-comment">-- @constructorCaseType R (A-&gt;Maybe A) = (A -&gt; R)@</span><span>
</span><a name="line-35"></a><span class="hs-identifier">constructorCaseType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PLC.Type</span><span> </span><a href="#local-6989586621679186615"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186616"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VarDecl</span><span> </span><a href="#local-6989586621679186615"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186617"><span class="hs-identifier hs-type">name</span></a><span> </span><a href="#local-6989586621679186616"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PLC.Type</span><span> </span><a href="#local-6989586621679186615"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186616"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-36"></a><a name="constructorCaseType"><a href="Language.PlutusIR.Compiler.Datatype.html#constructorCaseType"><span class="hs-identifier">constructorCaseType</span></a></a><span> </span><a name="local-6989586621679186625"><a href="#local-6989586621679186625"><span class="hs-identifier">resultType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#replaceFunTyTarget"><span class="hs-identifier hs-var">replaceFunTyTarget</span></a><span> </span><a href="#local-6989586621679186625"><span class="hs-identifier hs-var">resultType</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">varDeclType</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-comment">-- | Get the argument types of a function type.</span><span>
</span><a name="line-39"></a><span class="hs-comment">-- @funTyArgs (A-&gt;B-&gt;C) = [A, B]@</span><span>
</span><a name="line-40"></a><span class="hs-identifier">funTyArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PLC.Type</span><span> </span><a href="#local-6989586621679186613"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186614"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PLC.Type</span><span> </span><a href="#local-6989586621679186613"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186614"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-41"></a><a name="funTyArgs"><a href="Language.PlutusIR.Compiler.Datatype.html#funTyArgs"><span class="hs-identifier">funTyArgs</span></a></a><span> </span><a name="local-6989586621679186626"><a href="#local-6989586621679186626"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679186626"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-42"></a><span>    </span><span class="hs-identifier hs-var">PLC.TyFun</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186627"><a href="#local-6989586621679186627"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621679186628"><a href="#local-6989586621679186628"><span class="hs-identifier">t2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679186627"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#funTyArgs"><span class="hs-identifier hs-var">funTyArgs</span></a><span> </span><a href="#local-6989586621679186628"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-43"></a><span>    </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-comment">-- | Given the type of a constructor, get its argument types.</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- @constructorArgTypes (A-&gt;Maybe A) = [A]</span><span>
</span><a name="line-47"></a><span class="hs-identifier">constructorArgTypes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">VarDecl</span><span> </span><a href="#local-6989586621679186610"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186611"><span class="hs-identifier hs-type">name</span></a><span> </span><a href="#local-6989586621679186612"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PLC.Type</span><span> </span><a href="#local-6989586621679186610"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186612"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-48"></a><a name="constructorArgTypes"><a href="Language.PlutusIR.Compiler.Datatype.html#constructorArgTypes"><span class="hs-identifier">constructorArgTypes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#funTyArgs"><span class="hs-identifier hs-var">funTyArgs</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">varDeclType</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-comment">-- | &quot;Unveil&quot; a datatype definition in a type, by replacing uses of the name as a type variable with the concrete definition.</span><span>
</span><a name="line-51"></a><span class="hs-identifier">unveilDatatype</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679186607"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186608"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><a href="#local-6989586621679186607"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186608"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a><span> </span><a href="#local-6989586621679186607"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186609"><span class="hs-identifier hs-type">name</span></a><span> </span><a href="#local-6989586621679186608"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><a href="#local-6989586621679186607"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186608"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><a href="#local-6989586621679186607"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679186608"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-52"></a><a name="unveilDatatype"><a href="Language.PlutusIR.Compiler.Datatype.html#unveilDatatype"><span class="hs-identifier">unveilDatatype</span></a></a><span> </span><a name="local-6989586621679186629"><a href="#local-6989586621679186629"><span class="hs-identifier">dty</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-var">Datatype</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186630"><a href="#local-6989586621679186630"><span class="hs-identifier">tn</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PLC.substTy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679186631"><a href="#local-6989586621679186631"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679186631"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">tyVarDeclName</span><span> </span><a href="#local-6989586621679186630"><span class="hs-identifier hs-var">tn</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679186629"><span class="hs-identifier hs-var">dty</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-identifier">resultTypeName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#Compiling"><span class="hs-identifier hs-type">Compiling</span></a><span> </span><a href="#local-6989586621679186604"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679186605"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679186606"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186606"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679186604"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186606"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><a name="resultTypeName"><a href="Language.PlutusIR.Compiler.Datatype.html#resultTypeName"><span class="hs-identifier">resultTypeName</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-var">Datatype</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186632"><a href="#local-6989586621679186632"><span class="hs-identifier">tn</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ask</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679186633"><a href="#local-6989586621679186633"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftQuote</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">freshTyName</span><span> </span><a href="#local-6989586621679186633"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;out_&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nameString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unTyName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tyVarDeclName</span><span> </span><a href="#local-6989586621679186632"><span class="hs-identifier hs-var">tn</span></a><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-comment">-- Datatypes</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-comment">{- Note [Scott encoding of datatypes]
(This describes the conceptual scheme for converting data types - in fact we translate
them as abstract, so see also Note [Abstract data types].)

We translate our datatypes using the Scott encoding. The fundamental idea is that there is one thing
you can do with a datatype value: pattern match on it. A datatype value is therefore represented by
precisely the thing you need to do a pattern match. Namely, a function that takes functions implementing
each arm of the match, and then gives you a result.

We also need to think about the types. In general, we need:
- The encoded type corresponding to the datatype itself
- The encoded type of each constructor
- The encoded term for each constructor
- The encoded type of the destructor
- The encoded term for the destructor

-- Basic example

For example, consider 'Maybe a'. Then:
- The type corresponding to the datatype is:
  Maybe = \(a :: *) -&gt; forall out_Maybe . out_maybe -&gt; (a -&gt; out_Maybe) -&gt; out_Maybe
- The type of the constructors are:
  Just : forall (a :: *) . a -&gt; Maybe a
  Nothing : forall (a :: *) . Maybe a
- The terms for the constructors are:
  Just = \(arg1 : a). /\ (out_Maybe :: *) . \(case_Nothing : out_Maybe) (case_Just : a -&gt; out_Maybe) . case_Just arg1
  Nothing = /\ (out_Maybe :: *) . \(case_Nothing : out_Maybe) (caseJust : a -&gt; out_Maybe) . caseNothing
- The type of the destructor is:
  match_Maybe : forall (a :: *) . Maybe a -&gt; forall (out_Maybe :: *) . out_maybe -&gt; (a -&gt; out_maybe) -&gt; out_maybe
- The term for the destructor is:
  match_Maybe = /\(a :: *) -&gt; \(x : Maybe a) -&gt; x

(Constructors and destructors are much more necessary when we define the datatype as abstract,
rather than inlining it, see Note [Abstract data types]. However, it is easier to present them here
as a slightly unnecessary generality.)

-- General case

Consider a datatype as defined in Plutus IR:
(datatype
  (tyvardecl T (type))
  (tyvardecl a_1 t_1)
  ..
  (tyvardecl a_n t_n)
  match_T
  (vardecl c_1 (fun t_c_1_1 .. (fun t_c_1_(c_1_k)) [T t1 .. tn]))
  ..
  (vardecl c_j (fun t_c_j_1 .. (fun t_c_j_(c_j_k)) [T t1 .. tn]))
)

That is, it has:
- Name T
- Kind *
- n type parameters of type t_1 to t_n
- Destructor match_t
_ j constructors with c_i_k arguments each of types t_c_i_1 to t_c_i_(c_i_k)

The type corresponding to the datatype is:
\(t_1 :: *) .. (t_n :: *) .
  forall out_T :: * .
    (t_c_1_1 -&gt; .. -&gt; t_c_1_(c_1_k) -&gt; out_T) -&gt; .. -&gt; (t_c_j_1 -&gt; .. -&gt; t_c_j_(c_j_k) -&gt; out_T) -&gt;
      out_T

The type of the constructor c_i is:
forall (t_1 :: *) .. (t_n :: *) .
  t_c_i_1 -&gt; .. -&gt; t_c_i_(c_i_k) -&gt;
    (T t_1 .. t_n)
This is actually declared for us in the datatype declaration, but without the type
variables being abstracted out. We use this to get the argument types of the constructor.

The term for the constructor c_i is:
/\(t_1 :: *) .. (t_n :: *) .
  \(a_1 : t_c_j_1) .. (a_c_i_(c_i_k) : t_c_i_(c_i_k)) .
    abs out_T :: * .
      \(case_c_1 : (t_c_1_1 -&gt; .. -&gt; t_c_1_(c_1_k) -&gt; out_T)) .. (case_c_j : (t_c_j_1 -&gt; .. -&gt; t_c_j_(c_j_k) -&gt; out_T)) .
        case_c_i a_1 .. a_c_i_(c_i_k)

The type of the destructor is:
forall (t_1 :: *) .. (t_n :: *) .
  (T t_1 .. t_n) -&gt;
    forall out_T :: * .
      (t_c_1_1 -&gt; .. -&gt; t_c_1_(c_1_k) -&gt; out_T) -&gt; .. -&gt; (t_c_j_1 -&gt; .. -&gt; t_c_j_(c_j_k) -&gt; out_T) -&gt;
        out_T

The term for the destructor is:
/\(t_1 :: *) .. (t_n :: *) .
  \(x :: (T t_1 .. t_n)) -&gt;
    x

-- Compiling uses of datatypes

We turn constructor invocations into calls to the constructor functions.

Pattern matching is slightly more complex as we need to turn it into an invocation of the destructor:
- We take each alternative, turn it into a function of its bound variables.
- We apply the destructor to the scrutinee, and then instantiate that (which will be polymorphic
  in the result type) at the type of the overall match expression.
    - This does indicate one wrinkle: we need to know the overall type, we can't infer it.
- We apply the instantiated value to the functions for each alternative.
-}</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-comment">{- Note [Abstract data types]
While the Scott encoding makes it easy to simply convert all types inline, it
is convenient for a number of reasons to instead abstract out data types. Namely:
- The resulting code is much more readable, since we have named types instead
of (potentially big) inlined types.
- We generate less code because we're not repeating the definition at every use site.

The basic idea is to &quot;let-bind&quot; types using type abstractions, and values using
lambda abstractions. There are a few considerations that make this tricky, however:

1. When types are inlined, the Scott encoding allows us to construct values by
  constructing the matching function inline. When they are abstract, we need to provide
  (suitably polymorphic) constructors abstractly.
2. When types are inlined, the Scott encoding allows us to match against a type by
  simply using it as a function. When they are abstract, we need to provide a
  (suitably polymorphic) matching function abstractly.
3. The definition of a type must be abstract in the binding types of the constructors and destructors
  (so they can be used alongside the abstract type), but it must *not* be abstract in the
  *definition* of the constructors or destructors, because they depend on knowing the real structure
  of the type.
    1. In fact we can do slightly better than this: in the constructors of a recursive datatype we can use the type
       as a name inside the 'wrap'.

Consequently, for a single type we end up with something like the following:

(forall ty :: * .
  -- ty abstract in these types
  \(c_1 : &lt;constructor type i&gt;) .. (c_j : &lt;constructor type j&gt;) .
    -- ty abstract in this type
    \match : &lt;destructor type&gt; .
      &lt;user term&gt;
)
&lt;defn of ty&gt;
-- ty concrete in these terms, except maybe inside a 'wrap'
&lt;defn of c_1&gt;
..
&lt;defn of c_j&gt;
-- ty concrete in this term
&lt;defn of match&gt;

(see Note [Scott encoding of datatypes] for how the actual definitions are constructed)
-}</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span class="hs-comment">{- Note [Recursive data types]
Recursive data types make the scheme described in [Scott encoding of datatypes] a bit more
complex. At the moment we only support self-recursive datatypes.

For a (self-)recursive datatype we have to change three things:
- The type of the datatype itself must have an enclosing fix over the type variable for
  the type itself.
- Constructors must include a wrap.
- Destructors must include an unwrap.
-}</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-comment">-- See note [Scott encoding of datatypes]</span><span>
</span><a name="line-215"></a><span class="hs-comment">-- | Make the &quot;Scott-encoded&quot; type for a 'Datatype', with type variables free.</span><span>
</span><a name="line-216"></a><span class="hs-comment">-- @mkScottTy Maybe = forall out_Maybe. out_Maybe -&gt; (a -&gt; out_Maybe) -&gt; out_Maybe@</span><span>
</span><a name="line-217"></a><span class="hs-identifier">mkScottTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679186601"><a href="#local-6989586621679186601"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679186602"><a href="#local-6989586621679186602"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621679186603"><a href="#local-6989586621679186603"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-operator">.</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#Compiling"><span class="hs-identifier hs-type">Compiling</span></a><span> </span><a href="#local-6989586621679186601"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679186602"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679186603"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186603"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679186601"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Types.html#PLCType"><span class="hs-identifier hs-type">PLCType</span></a><span> </span><a href="#local-6989586621679186603"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><a name="mkScottTy"><a href="Language.PlutusIR.Compiler.Datatype.html#mkScottTy"><span class="hs-identifier">mkScottTy</span></a></a><span> </span><a name="local-6989586621679186634"><a href="#local-6989586621679186634"><span class="hs-identifier">d</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-var">Datatype</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186635"><a href="#local-6989586621679186635"><span class="hs-identifier">constrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-219"></a><span>    </span><a name="local-6989586621679186636"><a href="#local-6989586621679186636"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-220"></a><span>    </span><a name="local-6989586621679186637"><a href="#local-6989586621679186637"><span class="hs-identifier">resultType</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#resultTypeName"><span class="hs-identifier hs-var">resultTypeName</span></a><span> </span><a href="#local-6989586621679186634"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-221"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679186638"><a href="#local-6989586621679186638"><span class="hs-identifier">caseTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Datatype.html#constructorCaseType"><span class="hs-identifier hs-var">constructorCaseType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.TyVar</span><span> </span><a href="#local-6989586621679186636"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186637"><span class="hs-identifier hs-var">resultType</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186635"><span class="hs-identifier hs-var">constrs</span></a><span>
</span><a name="line-222"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-223"></a><span>        </span><span class="hs-comment">-- forall resultType</span><span>
</span><a name="line-224"></a><span>        </span><span class="hs-identifier hs-var">PLC.TyForall</span><span> </span><a href="#local-6989586621679186636"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186637"><span class="hs-identifier hs-var">resultType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.Type</span><span> </span><a href="#local-6989586621679186636"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-225"></a><span>        </span><span class="hs-comment">-- c_1 -&gt; .. -&gt; c_n -&gt; resultType</span><span>
</span><a name="line-226"></a><span>        </span><span class="hs-identifier hs-var">PLC.mkIterTyFun</span><span> </span><a href="#local-6989586621679186636"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186638"><span class="hs-identifier hs-var">caseTys</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.TyVar</span><span> </span><a href="#local-6989586621679186636"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186637"><span class="hs-identifier hs-var">resultType</span></a><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-comment">-- | Make the &quot;pattern functor&quot; of a 'Datatype'. This is just the normal type, but with the</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- type variable for the type itself free and its type variables free.</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- @mkDatatypePatternFunctor List = forall (r :: *) . r -&gt; (a -&gt; List a -&gt; r) -&gt; r@</span><span>
</span><a name="line-231"></a><span class="hs-identifier">mkDatatypePatternFunctor</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#Compiling"><span class="hs-identifier hs-type">Compiling</span></a><span> </span><a href="#local-6989586621679186598"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679186599"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679186600"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186600"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679186598"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Types.html#PLCType"><span class="hs-identifier hs-type">PLCType</span></a><span> </span><a href="#local-6989586621679186600"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><a name="mkDatatypePatternFunctor"><a href="Language.PlutusIR.Compiler.Datatype.html#mkDatatypePatternFunctor"><span class="hs-identifier">mkDatatypePatternFunctor</span></a></a><span> </span><a name="local-6989586621679186639"><a href="#local-6989586621679186639"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#DatatypeComponent"><span class="hs-identifier hs-var">DatatypeComponent</span></a><span> </span><a href="Language.PlutusIR.Compiler.Provenance.html#PatternFunctor"><span class="hs-identifier hs-var">PatternFunctor</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#mkScottTy"><span class="hs-identifier hs-var">mkScottTy</span></a><span> </span><a href="#local-6989586621679186639"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-comment">-- | Make the real PLC type corresponding to a 'Datatype' with the given pattern functor.</span><span>
</span><a name="line-235"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-236"></a><span class="hs-comment">--     mkDatatypeType List &lt;pattern functor of List&gt;</span><span>
</span><a name="line-237"></a><span class="hs-comment">--         = fix list . &lt;pattern functor of List&gt;</span><span>
</span><a name="line-238"></a><span class="hs-comment">--         = fix list . \(a :: *) -&gt; forall (r :: *) . r -&gt; (a -&gt; List a -&gt; r) -&gt; r</span><span>
</span><a name="line-239"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-240"></a><span class="hs-identifier">mkDatatypeType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679186595"><a href="#local-6989586621679186595"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679186596"><a href="#local-6989586621679186596"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621679186597"><a href="#local-6989586621679186597"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#Compiling"><span class="hs-identifier hs-type">Compiling</span></a><span> </span><a href="#local-6989586621679186595"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679186596"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679186597"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusIR.html#Recursivity"><span class="hs-identifier hs-type">Recursivity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#PLCType"><span class="hs-identifier hs-type">PLCType</span></a><span> </span><a href="#local-6989586621679186597"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186597"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679186595"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Types.html#PLCRecType"><span class="hs-identifier hs-type">PLCRecType</span></a><span> </span><a href="#local-6989586621679186597"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-241"></a><a name="mkDatatypeType"><a href="Language.PlutusIR.Compiler.Datatype.html#mkDatatypeType"><span class="hs-identifier">mkDatatypeType</span></a></a><span> </span><a name="local-6989586621679186640"><a href="#local-6989586621679186640"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679186641"><a href="#local-6989586621679186641"><span class="hs-identifier">pf</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-var">Datatype</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186642"><a href="#local-6989586621679186642"><span class="hs-identifier">tn</span></a></a><span> </span><a name="local-6989586621679186643"><a href="#local-6989586621679186643"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#DatatypeComponent"><span class="hs-identifier hs-var">DatatypeComponent</span></a><span> </span><a href="Language.PlutusIR.Compiler.Provenance.html#DatatypeType"><span class="hs-identifier hs-var">DatatypeType</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679186640"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-242"></a><span>    </span><a href="Language.PlutusIR.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#PlainType"><span class="hs-identifier hs-var">PlainType</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.mkIterTyLam</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679186643"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679186641"><span class="hs-identifier hs-var">pf</span></a><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>    </span><span class="hs-comment">-- See note [Recursive datatypes]</span><span>
</span><a name="line-244"></a><span>    </span><span class="hs-comment">-- We are reusing the same type name for the fixpoint variable. This is fine</span><span>
</span><a name="line-245"></a><span>    </span><span class="hs-comment">-- so long as we do renaming later, since we only reuse the name inside an inner binder</span><span>
</span><a name="line-246"></a><span>    </span><a href="Language.PlutusIR.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-247"></a><span>        </span><a name="local-6989586621679186644"><a href="#local-6989586621679186644"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-248"></a><span>        </span><a href="Language.PlutusIR.Compiler.Types.html#RecursiveType"><span class="hs-identifier hs-var">RecursiveType</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftQuote</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Types.makeRecursiveType</span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186597"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186644"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyVarDeclName</span><span> </span><a href="#local-6989586621679186642"><span class="hs-identifier hs-var">tn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186643"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621679186641"><span class="hs-identifier hs-var">pf</span></a><span class="hs-special">)</span><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-comment">-- Constructors</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-comment">-- | Make the type of a constructor of a 'Datatype'. This is not quite the same as the declared type because the declared type has the</span><span>
</span><a name="line-253"></a><span class="hs-comment">-- type variables free.</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-255"></a><span class="hs-comment">--     mkConstructorType List Cons = forall (a :: *) . a -&gt; List a -&gt; List a</span><span>
</span><a name="line-256"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-257"></a><span class="hs-identifier">mkConstructorType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#Compiling"><span class="hs-identifier hs-type">Compiling</span></a><span> </span><a href="#local-6989586621679186592"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679186593"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679186594"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186594"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VarDecl</span><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186594"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679186592"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Types.html#PLCType"><span class="hs-identifier hs-type">PLCType</span></a><span> </span><a href="#local-6989586621679186594"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span class="hs-comment">-- this type appears *inside* the scope of the abstraction for the datatype so we can just reference the name and</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- we don't need to do anything to the declared type</span><span>
</span><a name="line-260"></a><span class="hs-comment">-- see note [Abstract data types]</span><span>
</span><a name="line-261"></a><a name="mkConstructorType"><a href="Language.PlutusIR.Compiler.Datatype.html#mkConstructorType"><span class="hs-identifier">mkConstructorType</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-var">Datatype</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186645"><a href="#local-6989586621679186645"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679186646"><a href="#local-6989586621679186646"><span class="hs-identifier">constr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#DatatypeComponent"><span class="hs-identifier hs-var">DatatypeComponent</span></a><span> </span><a href="Language.PlutusIR.Compiler.Provenance.html#ConstructorType"><span class="hs-identifier hs-var">ConstructorType</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PLC.mkIterTyForall</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679186645"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">varDeclType</span><span> </span><a href="#local-6989586621679186646"><span class="hs-identifier hs-var">constr</span></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-comment">-- See note [Scott encoding of datatypes]</span><span>
</span><a name="line-264"></a><span class="hs-comment">-- | Make a constructor of a 'Datatype' with the given pattern functor. The constructor argument mostly serves to identify the constructor</span><span>
</span><a name="line-265"></a><span class="hs-comment">-- that we are interested in in the list of constructors.</span><span>
</span><a name="line-266"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-267"></a><span class="hs-comment">--     mkConstructor &lt;definition of List&gt; &lt;pattern functor of List&gt; List Cons</span><span>
</span><a name="line-268"></a><span class="hs-comment">--         = /\(a :: *) . \(arg1 : a) (arg2 : &lt;definition of List&gt; a) .</span><span>
</span><a name="line-269"></a><span class="hs-comment">--             wrap &lt;pattern functor of List&gt; /\(out_List :: *) .</span><span>
</span><a name="line-270"></a><span class="hs-comment">--                 \(case_Nil : out_List) (case_Cons : a -&gt; List a -&gt; out_List) . case_Cons arg1 arg2</span><span>
</span><a name="line-271"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-272"></a><span class="hs-identifier">mkConstructor</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#Compiling"><span class="hs-identifier hs-type">Compiling</span></a><span> </span><a href="#local-6989586621679186589"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679186590"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679186591"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#PLCRecType"><span class="hs-identifier hs-type">PLCRecType</span></a><span> </span><a href="#local-6989586621679186591"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186591"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679186589"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Types.html#PLCTerm"><span class="hs-identifier hs-type">PLCTerm</span></a><span> </span><a href="#local-6989586621679186591"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-273"></a><a name="mkConstructor"><a href="Language.PlutusIR.Compiler.Datatype.html#mkConstructor"><span class="hs-identifier">mkConstructor</span></a></a><span> </span><a name="local-6989586621679186647"><a href="#local-6989586621679186647"><span class="hs-identifier">dty</span></a></a><span> </span><a name="local-6989586621679186648"><a href="#local-6989586621679186648"><span class="hs-identifier">d</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-var">Datatype</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186649"><a href="#local-6989586621679186649"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186650"><a href="#local-6989586621679186650"><span class="hs-identifier">constrs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679186651"><a href="#local-6989586621679186651"><span class="hs-identifier">index</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#DatatypeComponent"><span class="hs-identifier hs-var">DatatypeComponent</span></a><span> </span><a href="Language.PlutusIR.Compiler.Provenance.html#Constructor"><span class="hs-identifier hs-var">Constructor</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-274"></a><span>    </span><a name="local-6989586621679186652"><a href="#local-6989586621679186652"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-275"></a><span>    </span><a name="local-6989586621679186653"><a href="#local-6989586621679186653"><span class="hs-identifier">resultType</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#resultTypeName"><span class="hs-identifier hs-var">resultTypeName</span></a><span> </span><a href="#local-6989586621679186648"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span>    </span><span class="hs-comment">-- case arguments and their types</span><span>
</span><a name="line-278"></a><span>    </span><a name="local-6989586621679186837"><a href="#local-6989586621679186837"><span class="hs-identifier">casesAndTypes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-279"></a><span>          </span><span class="hs-comment">-- these types appear *outside* the scope of the abstraction for the datatype, so we need to use the concrete datatype here</span><span>
</span><a name="line-280"></a><span>          </span><span class="hs-comment">-- see note [Abstract data types]</span><span>
</span><a name="line-281"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679186654"><a href="#local-6989586621679186654"><span class="hs-identifier">caseTypes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#unveilDatatype"><span class="hs-identifier hs-var">unveilDatatype</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Types.html#getType"><span class="hs-identifier hs-var">getType</span></a><span> </span><a href="#local-6989586621679186647"><span class="hs-identifier hs-var">dty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186648"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Datatype.html#constructorCaseType"><span class="hs-identifier hs-var">constructorCaseType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.TyVar</span><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186653"><span class="hs-identifier hs-var">resultType</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186650"><span class="hs-identifier hs-var">constrs</span></a><span>
</span><a name="line-282"></a><span>          </span><a name="local-6989586621679186656"><a href="#local-6989586621679186656"><span class="hs-identifier">caseArgNames</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">for</span><span> </span><a href="#local-6989586621679186650"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679186655"><a href="#local-6989586621679186655"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Names.html#safeFreshName"><span class="hs-identifier hs-var">safeFreshName</span></a><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;case_&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#varDeclNameString"><span class="hs-identifier hs-var">varDeclNameString</span></a><span> </span><a href="#local-6989586621679186655"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>          </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarDecl</span><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186656"><span class="hs-identifier hs-var">caseArgNames</span></a><span> </span><a href="#local-6989586621679186654"><span class="hs-identifier hs-var">caseTypes</span></a><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span>    </span><span class="hs-comment">-- This is inelegant, but it should never fail</span><span>
</span><a name="line-286"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679186838"><a href="#local-6989586621679186838"><span class="hs-identifier">constr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679186650"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><a href="#local-6989586621679186651"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-287"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679186839"><a href="#local-6989586621679186839"><span class="hs-identifier">thisCase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PLC.mkVar</span><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679186837"><span class="hs-identifier hs-var">casesAndTypes</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><a href="#local-6989586621679186651"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span>    </span><span class="hs-comment">-- constructor args and their types</span><span>
</span><a name="line-290"></a><span>    </span><a name="local-6989586621679186843"><a href="#local-6989586621679186843"><span class="hs-identifier">argsAndTypes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-291"></a><span>          </span><span class="hs-comment">-- these types appear *outside* the scope of the abstraction for the datatype, so we need to use the concrete datatype here</span><span>
</span><a name="line-292"></a><span>          </span><span class="hs-comment">-- see note [Abstract data types]</span><span>
</span><a name="line-293"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679186840"><a href="#local-6989586621679186840"><span class="hs-identifier">argTypes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#unveilDatatype"><span class="hs-identifier hs-var">unveilDatatype</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Types.html#getType"><span class="hs-identifier hs-var">getType</span></a><span> </span><a href="#local-6989586621679186647"><span class="hs-identifier hs-var">dty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186648"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#constructorArgTypes"><span class="hs-identifier hs-var">constructorArgTypes</span></a><span> </span><a href="#local-6989586621679186838"><span class="hs-identifier hs-var">constr</span></a><span>
</span><a name="line-294"></a><span>        </span><span class="hs-comment">-- we don't have any names for these things, we just had the type, so we call them &quot;arg_i</span><span>
</span><a name="line-295"></a><span>        </span><a name="local-6989586621679186842"><a href="#local-6989586621679186842"><span class="hs-identifier">argNames</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">for</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679186840"><span class="hs-identifier hs-var">argTypes</span></a><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679186841"><a href="#local-6989586621679186841"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Names.html#safeFreshName"><span class="hs-identifier hs-var">safeFreshName</span></a><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;arg_&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">showText</span><span> </span><a href="#local-6989586621679186841"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarDecl</span><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186842"><span class="hs-identifier hs-var">argNames</span></a><span> </span><a href="#local-6989586621679186840"><span class="hs-identifier hs-var">argTypes</span></a><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-300"></a><span>        </span><span class="hs-comment">-- /\t_1 .. t_n</span><span>
</span><a name="line-301"></a><span>        </span><span class="hs-identifier hs-var">PLC.mkIterTyAbs</span><span> </span><a href="#local-6989586621679186649"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-302"></a><span>        </span><span class="hs-comment">-- \arg_1 .. arg_m</span><span>
</span><a name="line-303"></a><span>        </span><span class="hs-identifier hs-var">PLC.mkIterLamAbs</span><span> </span><a href="#local-6989586621679186843"><span class="hs-identifier hs-var">argsAndTypes</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-304"></a><span>        </span><span class="hs-comment">-- See Note [Recursive datatypes]</span><span>
</span><a name="line-305"></a><span>        </span><span class="hs-comment">-- wrap</span><span>
</span><a name="line-306"></a><span>        </span><a href="Language.PlutusIR.Compiler.Types.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186647"><span class="hs-identifier hs-var">dty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.mkTyVar</span><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186649"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-307"></a><span>        </span><span class="hs-comment">-- no need for a body value check here, we know it's a lambda (see Note [Value restriction])</span><span>
</span><a name="line-308"></a><span>        </span><span class="hs-comment">-- forall out</span><span>
</span><a name="line-309"></a><span>        </span><span class="hs-identifier hs-var">PLC.TyAbs</span><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186653"><span class="hs-identifier hs-var">resultType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.Type</span><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-310"></a><span>        </span><span class="hs-comment">-- \case_1 .. case_j</span><span>
</span><a name="line-311"></a><span>        </span><span class="hs-identifier hs-var">PLC.mkIterLamAbs</span><span> </span><a href="#local-6989586621679186837"><span class="hs-identifier hs-var">casesAndTypes</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-312"></a><span>        </span><span class="hs-comment">-- c_i arg_1 .. arg_m</span><span>
</span><a name="line-313"></a><span>        </span><span class="hs-identifier hs-var">PLC.mkIterApp</span><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186839"><span class="hs-identifier hs-var">thisCase</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.mkVar</span><span> </span><a href="#local-6989586621679186652"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186843"><span class="hs-identifier hs-var">argsAndTypes</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-comment">-- Destructors</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span class="hs-comment">-- See note [Scott encoding of datatypes]</span><span>
</span><a name="line-318"></a><span class="hs-comment">-- | Make the destructor for a 'Datatype'.</span><span>
</span><a name="line-319"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-320"></a><span class="hs-comment">--     mkDestructor &lt;definition of List&gt; List</span><span>
</span><a name="line-321"></a><span class="hs-comment">--        = /\(a :: *) -&gt; \(x : (&lt;definition of List&gt; a)) -&gt; unwrap x</span><span>
</span><a name="line-322"></a><span class="hs-comment">--        = /\(a :: *) -&gt; \(x : (fix List . \(a :: *) -&gt; forall (r :: *) . r -&gt; (a -&gt; List a -&gt; r) -&gt; r) a) -&gt; unwrap x</span><span>
</span><a name="line-323"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-324"></a><span class="hs-identifier">mkDestructor</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#Compiling"><span class="hs-identifier hs-type">Compiling</span></a><span> </span><a href="#local-6989586621679186586"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679186587"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679186588"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#PLCRecType"><span class="hs-identifier hs-type">PLCRecType</span></a><span> </span><a href="#local-6989586621679186588"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186588"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679186586"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Types.html#PLCTerm"><span class="hs-identifier hs-type">PLCTerm</span></a><span> </span><a href="#local-6989586621679186588"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-325"></a><a name="mkDestructor"><a href="Language.PlutusIR.Compiler.Datatype.html#mkDestructor"><span class="hs-identifier">mkDestructor</span></a></a><span> </span><a name="local-6989586621679186844"><a href="#local-6989586621679186844"><span class="hs-identifier">dty</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-var">Datatype</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186845"><a href="#local-6989586621679186845"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#DatatypeComponent"><span class="hs-identifier hs-var">DatatypeComponent</span></a><span> </span><a href="Language.PlutusIR.Compiler.Provenance.html#Destructor"><span class="hs-identifier hs-var">Destructor</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-326"></a><span>    </span><a name="local-6989586621679186846"><a href="#local-6989586621679186846"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span>    </span><span class="hs-comment">-- This term appears *outside* the scope of the abstraction for the datatype, so we need to put in the Scott-encoded type here</span><span>
</span><a name="line-329"></a><span>    </span><span class="hs-comment">-- see note [Abstract data types]</span><span>
</span><a name="line-330"></a><span>    </span><span class="hs-comment">-- dty t_1 .. t_n</span><span>
</span><a name="line-331"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679186847"><a href="#local-6989586621679186847"><span class="hs-identifier">appliedReal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PLC.mkIterTyApp</span><span> </span><a href="#local-6989586621679186846"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Types.html#getType"><span class="hs-identifier hs-var">getType</span></a><span> </span><a href="#local-6989586621679186844"><span class="hs-identifier hs-var">dty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.mkTyVar</span><span> </span><a href="#local-6989586621679186846"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186845"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span>    </span><a name="local-6989586621679186848"><a href="#local-6989586621679186848"><span class="hs-identifier">xn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusIR.Compiler.Names.html#safeFreshName"><span class="hs-identifier hs-var">safeFreshName</span></a><span> </span><a href="#local-6989586621679186846"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-string">&quot;x&quot;</span><span>
</span><a name="line-334"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-335"></a><span>        </span><span class="hs-comment">-- /\t_1 .. t_n</span><span>
</span><a name="line-336"></a><span>        </span><span class="hs-identifier hs-var">PLC.mkIterTyAbs</span><span> </span><a href="#local-6989586621679186845"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-337"></a><span>        </span><span class="hs-comment">-- \x</span><span>
</span><a name="line-338"></a><span>        </span><span class="hs-identifier hs-var">PLC.LamAbs</span><span> </span><a href="#local-6989586621679186846"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186848"><span class="hs-identifier hs-var">xn</span></a><span> </span><a href="#local-6989586621679186847"><span class="hs-identifier hs-var">appliedReal</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-339"></a><span>        </span><span class="hs-comment">-- See note [Recursive datatypes]</span><span>
</span><a name="line-340"></a><span>        </span><span class="hs-comment">-- unwrap</span><span>
</span><a name="line-341"></a><span>        </span><a href="Language.PlutusIR.Compiler.Types.html#unwrap"><span class="hs-identifier hs-var">unwrap</span></a><span> </span><a href="#local-6989586621679186846"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186844"><span class="hs-identifier hs-var">dty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-342"></a><span>        </span><span class="hs-identifier hs-var">PLC.Var</span><span> </span><a href="#local-6989586621679186846"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186848"><span class="hs-identifier hs-var">xn</span></a><span>
</span><a name="line-343"></a><span>
</span><a name="line-344"></a><span class="hs-comment">-- See note [Scott encoding of datatypes]</span><span>
</span><a name="line-345"></a><span class="hs-comment">-- | Make the type of a destructor for a 'Datatype'.</span><span>
</span><a name="line-346"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-347"></a><span class="hs-comment">--     mkDestructorTy &lt;pattern functor of List&gt; List</span><span>
</span><a name="line-348"></a><span class="hs-comment">--         = forall (a :: *) . (List a) -&gt; (&lt;pattern functor of List&gt;)</span><span>
</span><a name="line-349"></a><span class="hs-comment">--         = forall (a :: *) . (List a) -&gt; (forall (out_List :: *) . (out_List -&gt; (a -&gt; List a -&gt; out_List) -&gt; out_List))</span><span>
</span><a name="line-350"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-351"></a><span class="hs-identifier">mkDestructorTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#Compiling"><span class="hs-identifier hs-type">Compiling</span></a><span> </span><a href="#local-6989586621679186583"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679186584"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679186585"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#PLCType"><span class="hs-identifier hs-type">PLCType</span></a><span> </span><a href="#local-6989586621679186585"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186585"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679186583"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Types.html#PLCType"><span class="hs-identifier hs-type">PLCType</span></a><span> </span><a href="#local-6989586621679186585"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-352"></a><a name="mkDestructorTy"><a href="Language.PlutusIR.Compiler.Datatype.html#mkDestructorTy"><span class="hs-identifier">mkDestructorTy</span></a></a><span> </span><a name="local-6989586621679186849"><a href="#local-6989586621679186849"><span class="hs-identifier">pf</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-var">Datatype</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186850"><a href="#local-6989586621679186850"><span class="hs-identifier">tn</span></a></a><span> </span><a name="local-6989586621679186851"><a href="#local-6989586621679186851"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#DatatypeComponent"><span class="hs-identifier hs-var">DatatypeComponent</span></a><span> </span><a href="Language.PlutusIR.Compiler.Provenance.html#DestructorType"><span class="hs-identifier hs-var">DestructorType</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-353"></a><span>    </span><a name="local-6989586621679186852"><a href="#local-6989586621679186852"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span>    </span><span class="hs-comment">-- we essentially &quot;unveil&quot; the abstract type, so this</span><span>
</span><a name="line-356"></a><span>    </span><span class="hs-comment">-- is a function from the (instantiated) abstract type</span><span>
</span><a name="line-357"></a><span>    </span><span class="hs-comment">-- to the (unwrapped, i.e. the pattern functor of the) &quot;real&quot; Scott-encoded type that we can use as</span><span>
</span><a name="line-358"></a><span>    </span><span class="hs-comment">-- a destructor</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>    </span><span class="hs-comment">-- these types appears *inside* the scope of the abstraction for the datatype, so we can use a references to the name</span><span>
</span><a name="line-361"></a><span>    </span><span class="hs-comment">-- and we don't need to do anything to the pattern functor</span><span>
</span><a name="line-362"></a><span>    </span><span class="hs-comment">-- see note [Abstract data types]</span><span>
</span><a name="line-363"></a><span>    </span><span class="hs-comment">-- t t_1 .. t_n</span><span>
</span><a name="line-364"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679186853"><a href="#local-6989586621679186853"><span class="hs-identifier">appliedAbstract</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PLC.mkIterTyApp</span><span> </span><a href="#local-6989586621679186852"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.mkTyVar</span><span> </span><a href="#local-6989586621679186852"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186850"><span class="hs-identifier hs-var">tn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.mkTyVar</span><span> </span><a href="#local-6989586621679186852"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186851"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>    </span><span class="hs-comment">-- forall t_1 .. t_n</span><span>
</span><a name="line-366"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-367"></a><span>        </span><span class="hs-identifier hs-var">PLC.mkIterTyForall</span><span> </span><a href="#local-6989586621679186851"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-368"></a><span>        </span><span class="hs-identifier hs-var">PLC.TyFun</span><span> </span><a href="#local-6989586621679186852"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186853"><span class="hs-identifier hs-var">appliedAbstract</span></a><span> </span><a href="#local-6989586621679186849"><span class="hs-identifier hs-var">pf</span></a><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span class="hs-comment">-- The main function</span><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span class="hs-comment">-- | Compile a 'Datatype' bound with the given body.</span><span>
</span><a name="line-373"></a><span class="hs-identifier">compileDatatype</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#Compiling"><span class="hs-identifier hs-type">Compiling</span></a><span> </span><a href="#local-6989586621679186580"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679186581"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679186582"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusIR.html#Recursivity"><span class="hs-identifier hs-type">Recursivity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Types.html#PLCTerm"><span class="hs-identifier hs-type">PLCTerm</span></a><span> </span><a href="#local-6989586621679186582"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Provenance.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a><span> </span><a href="#local-6989586621679186582"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679186580"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Compiler.Types.html#PLCTerm"><span class="hs-identifier hs-type">PLCTerm</span></a><span> </span><a href="#local-6989586621679186582"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><a name="compileDatatype"><a href="Language.PlutusIR.Compiler.Datatype.html#compileDatatype"><span class="hs-identifier">compileDatatype</span></a></a><span> </span><a name="local-6989586621679186854"><a href="#local-6989586621679186854"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679186855"><a href="#local-6989586621679186855"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621679186856"><a href="#local-6989586621679186856"><span class="hs-identifier">d</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Datatype"><span class="hs-identifier hs-var">Datatype</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186857"><a href="#local-6989586621679186857"><span class="hs-identifier">tn</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679186858"><a href="#local-6989586621679186858"><span class="hs-identifier">destr</span></a></a><span> </span><a name="local-6989586621679186859"><a href="#local-6989586621679186859"><span class="hs-identifier">constrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-375"></a><span>    </span><a name="local-6989586621679186860"><a href="#local-6989586621679186860"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span>    </span><span class="hs-comment">-- we compute the pattern functor and pass it around to avoid recomputing it</span><span>
</span><a name="line-378"></a><span>    </span><a name="local-6989586621679186861"><a href="#local-6989586621679186861"><span class="hs-identifier">pf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#mkDatatypePatternFunctor"><span class="hs-identifier hs-var">mkDatatypePatternFunctor</span></a><span> </span><a href="#local-6989586621679186856"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-379"></a><span>    </span><a name="local-6989586621679186862"><a href="#local-6989586621679186862"><span class="hs-identifier">concreteTyDef</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">PLC.Def</span><span> </span><a href="#local-6989586621679186857"><span class="hs-identifier hs-var">tn</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#mkDatatypeType"><span class="hs-identifier hs-var">mkDatatypeType</span></a><span> </span><a href="#local-6989586621679186854"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679186861"><span class="hs-identifier hs-var">pf</span></a><span> </span><a href="#local-6989586621679186856"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span>    </span><a name="local-6989586621679186866"><a href="#local-6989586621679186866"><span class="hs-identifier">constrDefs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">for</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679186859"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679186863"><a href="#local-6989586621679186863"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679186864"><a href="#local-6989586621679186864"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-382"></a><span>        </span><a name="local-6989586621679186865"><a href="#local-6989586621679186865"><span class="hs-identifier">constrTy</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#mkConstructorType"><span class="hs-identifier hs-var">mkConstructorType</span></a><span> </span><a href="#local-6989586621679186856"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621679186863"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-383"></a><span>        </span><span class="hs-identifier hs-var">PLC.Def</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarDecl</span><span> </span><a href="#local-6989586621679186860"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varDeclName</span><span> </span><a href="#local-6989586621679186863"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186865"><span class="hs-identifier hs-var">constrTy</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#mkConstructor"><span class="hs-identifier hs-var">mkConstructor</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">PLC.defVal</span><span> </span><a href="#local-6989586621679186862"><span class="hs-identifier hs-var">concreteTyDef</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186856"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621679186864"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span>    </span><a name="local-6989586621679186868"><a href="#local-6989586621679186868"><span class="hs-identifier">destrDef</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-386"></a><span>        </span><a name="local-6989586621679186867"><a href="#local-6989586621679186867"><span class="hs-identifier">destTy</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#mkDestructorTy"><span class="hs-identifier hs-var">mkDestructorTy</span></a><span> </span><a href="#local-6989586621679186861"><span class="hs-identifier hs-var">pf</span></a><span> </span><a href="#local-6989586621679186856"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-387"></a><span>        </span><span class="hs-identifier hs-var">PLC.Def</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarDecl</span><span> </span><a href="#local-6989586621679186860"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679186858"><span class="hs-identifier hs-var">destr</span></a><span> </span><a href="#local-6989586621679186867"><span class="hs-identifier hs-var">destTy</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusIR.Compiler.Datatype.html#mkDestructor"><span class="hs-identifier hs-var">mkDestructor</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">PLC.defVal</span><span> </span><a href="#local-6989586621679186862"><span class="hs-identifier hs-var">concreteTyDef</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186856"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-390"></a><span>        </span><a name="local-6989586621679186869"><a href="#local-6989586621679186869"><span class="hs-identifier">tyVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">PLC.defVar</span><span> </span><a href="#local-6989586621679186862"><span class="hs-identifier hs-var">concreteTyDef</span></a><span class="hs-special">]</span><span>
</span><a name="line-391"></a><span>        </span><a name="local-6989586621679186870"><a href="#local-6989586621679186870"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Language.PlutusIR.Compiler.Types.html#getType"><span class="hs-identifier hs-var">getType</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">PLC.defVal</span><span> </span><a href="#local-6989586621679186862"><span class="hs-identifier hs-var">concreteTyDef</span></a><span class="hs-special">]</span><span>
</span><a name="line-392"></a><span>        </span><a name="local-6989586621679186871"><a href="#local-6989586621679186871"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">PLC.defVar</span><span> </span><a href="#local-6989586621679186866"><span class="hs-identifier hs-var">constrDefs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">PLC.defVar</span><span> </span><a href="#local-6989586621679186868"><span class="hs-identifier hs-var">destrDef</span></a><span class="hs-special">]</span><span>
</span><a name="line-393"></a><span>        </span><a name="local-6989586621679186872"><a href="#local-6989586621679186872"><span class="hs-identifier">vals</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">PLC.defVal</span><span> </span><a href="#local-6989586621679186866"><span class="hs-identifier hs-var">constrDefs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">PLC.defVal</span><span> </span><a href="#local-6989586621679186868"><span class="hs-identifier hs-var">destrDef</span></a><span class="hs-special">]</span><span>
</span><a name="line-394"></a><span>    </span><span class="hs-comment">-- See note [Abstract data types]</span><span>
</span><a name="line-395"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PLC.mkIterApp</span><span> </span><a href="#local-6989586621679186860"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.mkIterInst</span><span> </span><a href="#local-6989586621679186860"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.mkIterTyAbs</span><span> </span><a href="#local-6989586621679186869"><span class="hs-identifier hs-var">tyVars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.mkIterLamAbs</span><span> </span><a href="#local-6989586621679186871"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621679186855"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186870"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679186872"><span class="hs-identifier hs-var">vals</span></a><span>
</span><a name="line-396"></a></pre></body></html>