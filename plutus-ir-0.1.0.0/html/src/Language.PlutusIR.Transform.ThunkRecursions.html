<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase        #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- | Implements a PIR-to-PIR transformation that makes all recursive term definitions</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- compilable to PLC. See Note [Thunking recursions] for details.</span><span>
</span><a name="line-6"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.PlutusIR.Transform.ThunkRecursions</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier hs-var">thunkRecursionsTerm</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">PlutusPrelude</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusIR.html"><span class="hs-identifier">Language.PlutusIR</span></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusIR.MkPir.html"><span class="hs-identifier">Language.PlutusIR.MkPir</span></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusIR.Transform.Substitute.html"><span class="hs-identifier">Language.PlutusIR.Transform.Substitute</span></a><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.PlutusCore.Quote</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusCore.StdLib.Data.Unit</span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Unit</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Lens</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span>                               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Traversable</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-comment">{- Note [Thunking recursions]
Our fixpoint combinators in Plutus Core know how to handle mutually recursive values
of *function type*. That is, we can define `map : List Int -&gt; List Int` but *not*
`map : forall a . List a -&gt; List a`, because the latter has a universally
qualified type, instead of a function type (although it is a function underneath).

We could solve this problem for universally quantified values by lifting the forall
out of the recursion. This is a bit like performing the following transformation:

    map : forall a b . (a -&gt; b) -&gt; List a -&gt; List b
    map f xs = case xs of
        [] -&gt; []
        x:xs -&gt; f x : map f xs

vs

    -- non-recursive
    map : forall a b . (a -&gt; b) -&gt; List a -&gt; List a
    map = map'
        where
            -- recursive, but *monomorphic* in the 'a' and 'b' we instantiate to, so of
            -- simple function type
            map' : (a -&gt; b) -&gt; List a -&gt; List b
            map' f xs = case xs of
                [] -&gt; []
                x:xs -&gt; f x : map' f xs

However, this has two drawbacks:
- It only works for polymorphic functions. There are other kinds of non-function
  values which we might want to define recursively.
- It doesn't work if we use polymorphic recursion, because the function we are
  defining is monomorphic, so the recursive call must be at the same type.

The latter is quite annoying, because in practice all interesting functions over
irregular datatypes will use polymorphic recursion, and we've gone to some lengths
to allow ourselves to define irregular datatypes.

The alternative solution is: given a proposed recursive definition of a value of
non-function type, we simply *make* it into a value of function type, by adding
a unit argument and forcing it at all the uses in the body.

So we do something like this:

    -- non-recursive, acts as an &quot;adaptor&quot; for other consumers of the original function
    map : forall a b . (a -&gt; b) -&gt; List a -&gt; List b
    map = map' () @a
        where
            -- recursive, but thunked, so of simple function type
            map' : () -&gt; forall a' b' . (a' -&gt; b') -&gt; List a' -&gt; List b'
            map' _ f xs = case xs of
                [] -&gt; []
                x:xs -&gt; f x : (map' () @b) f xs

This has the advantage of always working, but it's annoying because we have to go
in and edit the body of the function definition.

The algorithm operates as follows:
- Given a recursive let binding with some bindings that need thunking (i.e. are not of simple function type):
    - For each binding that needs thunking with name `n`, type `t`, and body `b`:
        - Make a new binding with a new name `n'`, type `() -&gt; t` and body `\() -&gt; b`.
        - Add the mapping `n =&gt; n' ()` into a substitution map.
        - Make an adaptor binding with name `n`, type `t`, and body `n' ()`.
    - Use the substitution map to replace all occurrences of old names inside the new bindings and any bindings
      that didn't need thunking.
    - The final term is `let rec &lt;new bindings ++ non thunked bindings&gt; in let nonrec &lt;adaptor bindings&gt; in &lt;original body&gt;`.
-}</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-comment">{- Note [Transformation vs compilation]
We have two options for where we can put this transformation:
- We can do it on-demand during compilation.
- We can do it in advance in a separate pass.

The advantage of the former is that it makes compilation &quot;more total&quot;, otherwise
we have to have a case where we give an error if we see a recursive binding we can't
handle, even if we've already run the pass to get rid of them.

(If we were doing a &quot;Trees that Grow&quot; approach we could disable the constructor afterwards,
which would be pretty nice.)

However, the advantage of the second approach is that it keeps it separate and independently
testable, which is handy.

This isn't very clear-cut - since PIR is a superset of PLC, we could implement our compiler
as a set of transformations, each of which eliminates one of the PIR features, until we're only
left with the PLC subset. This would be quite elegant - except that the final &quot;lowering&quot; step
would be quite ugly as it would just have to fail if it saw any PIR features.
-}</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-identifier">isFunctionType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><a href="#local-6989586621679205394"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679205395"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-112"></a><a name="isFunctionType"><a href="Language.PlutusIR.Transform.ThunkRecursions.html#isFunctionType"><span class="hs-identifier">isFunctionType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-113"></a><span>    </span><span class="hs-identifier hs-var">TyFun</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-identifier">needsThunking</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusIR.html#Binding"><span class="hs-identifier hs-type">Binding</span></a><span> </span><a href="#local-6989586621679205391"><span class="hs-identifier hs-type">tyname</span></a><span> </span><a href="#local-6989586621679205392"><span class="hs-identifier hs-type">name</span></a><span> </span><a href="#local-6989586621679205393"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-117"></a><a name="needsThunking"><a href="Language.PlutusIR.Transform.ThunkRecursions.html#needsThunking"><span class="hs-identifier">needsThunking</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-118"></a><span>    </span><a href="Language.PlutusIR.html#TermBind"><span class="hs-identifier hs-var">TermBind</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679205396"><a href="#local-6989586621679205396"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#isFunctionType"><span class="hs-identifier hs-var">isFunctionType</span></a><span> </span><a href="#local-6989586621679205396"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-119"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-identifier">thunkRecursionsBinding</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadQuote</span><span> </span><a href="#local-6989586621679205389"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusIR.html#Binding"><span class="hs-identifier hs-type">Binding</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><a href="#local-6989586621679205390"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679205389"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Binding"><span class="hs-identifier hs-type">Binding</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><a href="#local-6989586621679205390"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-122"></a><a name="thunkRecursionsBinding"><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsBinding"><span class="hs-identifier">thunkRecursionsBinding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-123"></a><span>    </span><a href="Language.PlutusIR.html#TermBind"><span class="hs-identifier hs-var">TermBind</span></a><span> </span><a name="local-6989586621679205397"><a href="#local-6989586621679205397"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679205398"><a href="#local-6989586621679205398"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621679205399"><a href="#local-6989586621679205399"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#TermBind"><span class="hs-identifier hs-var">TermBind</span></a><span> </span><a href="#local-6989586621679205397"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679205398"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier hs-var">thunkRecursionsTerm</span></a><span> </span><a href="#local-6989586621679205399"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-124"></a><span>    </span><span class="hs-comment">-- nothing to do for type bindings or datatype bindings</span><span>
</span><a name="line-125"></a><span>    </span><a name="local-6989586621679205400"><a href="#local-6989586621679205400"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679205400"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-identifier">thunkRecursionsTerm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadQuote</span><span> </span><a href="#local-6989586621679205387"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusIR.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><a href="#local-6989586621679205388"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679205387"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><a href="#local-6989586621679205388"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><a name="thunkRecursionsTerm"><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier">thunkRecursionsTerm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-129"></a><span>    </span><a href="Language.PlutusIR.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-6989586621679205401"><a href="#local-6989586621679205401"><span class="hs-identifier">x</span></a></a><span> </span><a href="Language.PlutusIR.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621679205402"><a href="#local-6989586621679205402"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621679205403"><a href="#local-6989586621679205403"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-130"></a><span>        </span><span class="hs-comment">-- See Note [Thunking recursions]</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span>        </span><span class="hs-comment">-- TODO: possibly this should use provenances?</span><span>
</span><a name="line-133"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679205404"><a href="#local-6989586621679205404"><span class="hs-identifier">generated</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679205401"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span>        </span><a name="local-6989586621679205405"><a href="#local-6989586621679205405"><span class="hs-identifier">t'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier hs-var">thunkRecursionsTerm</span></a><span> </span><a href="#local-6989586621679205403"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-136"></a><span>        </span><a name="local-6989586621679205406"><a href="#local-6989586621679205406"><span class="hs-identifier">bs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsBinding"><span class="hs-identifier hs-var">thunkRecursionsBinding</span></a><span> </span><a href="#local-6989586621679205402"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679205407"><a href="#local-6989586621679205407"><span class="hs-identifier">needThunking</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679205408"><a href="#local-6989586621679205408"><span class="hs-identifier">okay</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#needsThunking"><span class="hs-identifier hs-var">needsThunking</span></a><span> </span><a href="#local-6989586621679205406"><span class="hs-identifier hs-var">bs'</span></a><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679205407"><span class="hs-identifier hs-var">needThunking</span></a><span>
</span><a name="line-141"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusIR.MkPir.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a><span> </span><a href="#local-6989586621679205401"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="Language.PlutusIR.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a href="#local-6989586621679205408"><span class="hs-identifier hs-var">okay</span></a><span> </span><a href="#local-6989586621679205405"><span class="hs-identifier hs-var">t'</span></a><span>
</span><a name="line-142"></a><span>        </span><span class="hs-keyword">else</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#constructThunkedLet"><span class="hs-identifier hs-var">constructThunkedLet</span></a><span> </span><a href="#local-6989586621679205404"><span class="hs-identifier hs-var">generated</span></a><span> </span><a href="#local-6989586621679205408"><span class="hs-identifier hs-var">okay</span></a><span> </span><a href="#local-6989586621679205407"><span class="hs-identifier hs-var">needThunking</span></a><span> </span><a href="#local-6989586621679205405"><span class="hs-identifier hs-var">t'</span></a><span>
</span><a name="line-143"></a><span>    </span><span class="hs-comment">-- boring cases</span><span>
</span><a name="line-144"></a><span>    </span><a href="Language.PlutusIR.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-6989586621679205409"><a href="#local-6989586621679205409"><span class="hs-identifier">x</span></a></a><span> </span><a href="Language.PlutusIR.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621679205410"><a href="#local-6989586621679205410"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621679205411"><a href="#local-6989586621679205411"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a href="#local-6989586621679205409"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="Language.PlutusIR.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsBinding"><span class="hs-identifier hs-var">thunkRecursionsBinding</span></a><span> </span><a href="#local-6989586621679205410"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier hs-var">thunkRecursionsTerm</span></a><span> </span><a href="#local-6989586621679205411"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-145"></a><span>    </span><a href="Language.PlutusIR.html#TyAbs"><span class="hs-identifier hs-var">TyAbs</span></a><span> </span><a name="local-6989586621679205412"><a href="#local-6989586621679205412"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679205413"><a href="#local-6989586621679205413"><span class="hs-identifier">tn</span></a></a><span> </span><a name="local-6989586621679205414"><a href="#local-6989586621679205414"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679205415"><a href="#local-6989586621679205415"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#TyAbs"><span class="hs-identifier hs-var">TyAbs</span></a><span> </span><a href="#local-6989586621679205412"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679205413"><span class="hs-identifier hs-var">tn</span></a><span> </span><a href="#local-6989586621679205414"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier hs-var">thunkRecursionsTerm</span></a><span> </span><a href="#local-6989586621679205415"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-146"></a><span>    </span><a href="Language.PlutusIR.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a><span> </span><a name="local-6989586621679205416"><a href="#local-6989586621679205416"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679205417"><a href="#local-6989586621679205417"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679205418"><a href="#local-6989586621679205418"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621679205419"><a href="#local-6989586621679205419"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a><span> </span><a href="#local-6989586621679205416"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679205417"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679205418"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier hs-var">thunkRecursionsTerm</span></a><span> </span><a href="#local-6989586621679205419"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-147"></a><span>    </span><a href="Language.PlutusIR.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span> </span><a name="local-6989586621679205420"><a href="#local-6989586621679205420"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679205421"><a href="#local-6989586621679205421"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621679205422"><a href="#local-6989586621679205422"><span class="hs-identifier">t2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span> </span><a href="#local-6989586621679205420"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier hs-var">thunkRecursionsTerm</span></a><span> </span><a href="#local-6989586621679205421"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier hs-var">thunkRecursionsTerm</span></a><span> </span><a href="#local-6989586621679205422"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-148"></a><span>    </span><a href="Language.PlutusIR.html#TyInst"><span class="hs-identifier hs-var">TyInst</span></a><span> </span><a name="local-6989586621679205423"><a href="#local-6989586621679205423"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679205424"><a href="#local-6989586621679205424"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679205425"><a href="#local-6989586621679205425"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#TyInst"><span class="hs-identifier hs-var">TyInst</span></a><span> </span><a href="#local-6989586621679205423"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier hs-var">thunkRecursionsTerm</span></a><span> </span><a href="#local-6989586621679205424"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679205425"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-149"></a><span>    </span><a href="Language.PlutusIR.html#IWrap"><span class="hs-identifier hs-var">IWrap</span></a><span> </span><a name="local-6989586621679205426"><a href="#local-6989586621679205426"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679205427"><a href="#local-6989586621679205427"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621679205428"><a href="#local-6989586621679205428"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621679205429"><a href="#local-6989586621679205429"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#IWrap"><span class="hs-identifier hs-var">IWrap</span></a><span> </span><a href="#local-6989586621679205426"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679205427"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621679205428"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier hs-var">thunkRecursionsTerm</span></a><span> </span><a href="#local-6989586621679205429"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-150"></a><span>    </span><a href="Language.PlutusIR.html#Unwrap"><span class="hs-identifier hs-var">Unwrap</span></a><span> </span><a name="local-6989586621679205430"><a href="#local-6989586621679205430"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679205431"><a href="#local-6989586621679205431"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#Unwrap"><span class="hs-identifier hs-var">Unwrap</span></a><span> </span><a href="#local-6989586621679205430"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#thunkRecursionsTerm"><span class="hs-identifier hs-var">thunkRecursionsTerm</span></a><span> </span><a href="#local-6989586621679205431"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-151"></a><span>    </span><a name="local-6989586621679205432"><a href="#local-6989586621679205432"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679205432"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-keyword">data</span><span> </span><a name="ThunkedNonTermBinding"><a href="Language.PlutusIR.Transform.ThunkRecursions.html#ThunkedNonTermBinding"><span class="hs-identifier">ThunkedNonTermBinding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ThunkedNonTermBinding"><a href="Language.PlutusIR.Transform.ThunkRecursions.html#ThunkedNonTermBinding"><span class="hs-identifier">ThunkedNonTermBinding</span></a></a><span>
</span><a name="line-154"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#ThunkedNonTermBinding"><span class="hs-identifier hs-type">ThunkedNonTermBinding</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-155"></a><span>    </span><a name="local-8214565720323790000"><span class="hs-identifier">show</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Tried to thunk a non-term binding. This should never happen, please report a bug to the Plutus Team&quot;</span><span>
</span><a name="line-156"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#ThunkedNonTermBinding"><span class="hs-identifier hs-type">ThunkedNonTermBinding</span></a><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-comment">-- See Note [Thunking recursions]</span><span>
</span><a name="line-159"></a><span class="hs-identifier">constructThunkedLet</span><span>
</span><a name="line-160"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadQuote</span><span> </span><a href="#local-6989586621679205385"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679205386"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-162"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Language.PlutusIR.html#Binding"><span class="hs-identifier hs-type">Binding</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><a href="#local-6989586621679205386"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Language.PlutusIR.html#Binding"><span class="hs-identifier hs-type">Binding</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><a href="#local-6989586621679205386"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-164"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusIR.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><a href="#local-6989586621679205386"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-165"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679205385"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><a href="#local-6989586621679205386"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-166"></a><a name="constructThunkedLet"><a href="Language.PlutusIR.Transform.ThunkRecursions.html#constructThunkedLet"><span class="hs-identifier">constructThunkedLet</span></a></a><span> </span><a name="local-6989586621679205433"><a href="#local-6989586621679205433"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621679205434"><a href="#local-6989586621679205434"><span class="hs-identifier">okay</span></a></a><span> </span><a name="local-6989586621679205435"><a href="#local-6989586621679205435"><span class="hs-identifier">needThunking</span></a></a><span> </span><a name="local-6989586621679205436"><a href="#local-6989586621679205436"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-167"></a><span>    </span><span class="hs-comment">-- These are all going to be used in a &quot;closed&quot; fashion, so it's fine to reuse them so long</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-comment">-- as we rename before typechecking.</span><span>
</span><a name="line-169"></a><span>    </span><a name="local-6989586621679205437"><a href="#local-6989586621679205437"><span class="hs-identifier">argName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftQuote</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">freshName</span><span> </span><a href="#local-6989586621679205433"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-string">&quot;arg&quot;</span><span>
</span><a name="line-170"></a><span>    </span><span class="hs-keyword">unit</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621679205433"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-operator hs-var">&lt;&lt;$&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">liftQuote</span><span> </span><span class="hs-identifier hs-var">Unit.getBuiltinUnit</span><span>
</span><a name="line-171"></a><span>    </span><a name="local-6989586621679205439"><a href="#local-6989586621679205439"><span class="hs-identifier">unitval</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621679205433"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-operator hs-var">&lt;&lt;$&gt;&gt;</span><span> </span><a href="Language.PlutusIR.html#embedIntoIR"><span class="hs-identifier hs-var">embedIntoIR</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">liftQuote</span><span> </span><span class="hs-identifier hs-var">Unit.getBuiltinUnitval</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span>    </span><span class="hs-comment">{-
    We need several pieces, and it is convenient to construct them simultaneously:
    - A new name for the thunked binding.
    - A substitution mapping from the old name to a forced application of the new name.
    - The new thunked binding (using the new name, and a delayed type).
    - An adaptor binding from the old name to a forced application of the new name, so that
      existing consumers inside the let binding can be left untouched.
    -}</span><span>
</span><a name="line-181"></a><span>    </span><a name="local-6989586621679205451"><a href="#local-6989586621679205451"><span class="hs-identifier">processed</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">for</span><span> </span><a href="#local-6989586621679205435"><span class="hs-identifier hs-var">needThunking</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-182"></a><span>        </span><a href="Language.PlutusIR.html#TermBind"><span class="hs-identifier hs-var">TermBind</span></a><span> </span><a name="local-6989586621679205440"><a href="#local-6989586621679205440"><span class="hs-identifier">x'</span></a></a><span> </span><a name="local-6989586621679205441"><a href="#local-6989586621679205441"><span class="hs-identifier">oldVd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarDecl</span><span> </span><a name="local-6989586621679205442"><a href="#local-6989586621679205442"><span class="hs-identifier">x''</span></a></a><span> </span><a name="local-6989586621679205443"><a href="#local-6989586621679205443"><span class="hs-identifier">oldName</span></a></a><span> </span><a name="local-6989586621679205444"><a href="#local-6989586621679205444"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679205445"><a href="#local-6989586621679205445"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-183"></a><span>            </span><a name="local-6989586621679205446"><a href="#local-6989586621679205446"><span class="hs-identifier">newName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftQuote</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">freshName</span><span> </span><a href="#local-6989586621679205433"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">nameString</span><span> </span><a href="#local-6989586621679205443"><span class="hs-identifier hs-var">oldName</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;_thunked&quot;</span><span>
</span><a name="line-184"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679205447"><a href="#local-6989586621679205447"><span class="hs-identifier">forcedApp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusIR.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span> </span><a href="#local-6989586621679205433"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621679205433"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="#local-6989586621679205446"><span class="hs-identifier hs-var">newName</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679205439"><span class="hs-identifier hs-var">unitval</span></a><span>
</span><a name="line-185"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679205448"><a href="#local-6989586621679205448"><span class="hs-identifier">substitution</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679205443"><span class="hs-identifier hs-var">oldName</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679205447"><span class="hs-identifier hs-var">forcedApp</span></a><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679205449"><a href="#local-6989586621679205449"><span class="hs-identifier">thunked</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusIR.html#TermBind"><span class="hs-identifier hs-var">TermBind</span></a><span> </span><a href="#local-6989586621679205440"><span class="hs-identifier hs-var">x'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarDecl</span><span> </span><a href="#local-6989586621679205442"><span class="hs-identifier hs-var">x''</span></a><span> </span><a href="#local-6989586621679205446"><span class="hs-identifier hs-var">newName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyFun</span><span> </span><a href="#local-6989586621679205433"><span class="hs-identifier hs-var">ann</span></a><span> </span><span class="hs-keyword">unit</span><span> </span><a href="#local-6989586621679205444"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a><span> </span><a href="#local-6989586621679205433"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="#local-6989586621679205437"><span class="hs-identifier hs-var">argName</span></a><span> </span><span class="hs-keyword">unit</span><span> </span><a href="#local-6989586621679205445"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679205450"><a href="#local-6989586621679205450"><span class="hs-identifier">adaptor</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusIR.html#TermBind"><span class="hs-identifier hs-var">TermBind</span></a><span> </span><a href="#local-6989586621679205433"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="#local-6989586621679205441"><span class="hs-identifier hs-var">oldVd</span></a><span> </span><a href="#local-6989586621679205447"><span class="hs-identifier hs-var">forcedApp</span></a><span>
</span><a name="line-188"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679205448"><span class="hs-identifier hs-var">substitution</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679205449"><span class="hs-identifier hs-var">thunked</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679205450"><span class="hs-identifier hs-var">adaptor</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>        </span><span class="hs-comment">-- This case shouldn't happen, since only term bindings will need thunking</span><span>
</span><a name="line-190"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throw</span><span> </span><a href="Language.PlutusIR.Transform.ThunkRecursions.html#ThunkedNonTermBinding"><span class="hs-identifier hs-var">ThunkedNonTermBinding</span></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679205452"><a href="#local-6989586621679205452"><span class="hs-identifier">thunkedBindings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679205451"><span class="hs-identifier hs-var">processed</span></a><span> </span><span class="hs-operator hs-var">^..</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_2</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679205600"><a href="#local-6989586621679205600"><span class="hs-identifier">newBindings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679205452"><span class="hs-identifier hs-var">thunkedBindings</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679205434"><span class="hs-identifier hs-var">okay</span></a><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span>    </span><span class="hs-comment">-- Now we have to handle references to the old name. All the references inside the RHSs of the bindings</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-comment">-- should be substituted for a forced application of the new name.</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679205601"><a href="#local-6989586621679205601"><span class="hs-identifier">renamedBindings</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-198"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679205602"><a href="#local-6989586621679205602"><span class="hs-identifier">substitutionMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679205451"><span class="hs-identifier hs-var">processed</span></a><span> </span><span class="hs-operator hs-var">^..</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_1</span><span>
</span><a name="line-199"></a><span>              </span><span class="hs-comment">-- substitution function for names</span><span>
</span><a name="line-200"></a><span>              </span><a name="local-6989586621679205603"><a href="#local-6989586621679205603"><span class="hs-identifier">nameF</span></a></a><span> </span><a name="local-6989586621679205605"><a href="#local-6989586621679205605"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679205605"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679205602"><span class="hs-identifier hs-var">substitutionMap</span></a><span>
</span><a name="line-201"></a><span>              </span><span class="hs-comment">-- do nothing for type names</span><span>
</span><a name="line-202"></a><span>              </span><a name="local-6989586621679205604"><a href="#local-6989586621679205604"><span class="hs-identifier">tynameF</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-203"></a><span>          </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusIR.Transform.Substitute.html#substBinding"><span class="hs-identifier hs-var">substBinding</span></a><span> </span><a href="#local-6989586621679205604"><span class="hs-identifier hs-var">tynameF</span></a><span> </span><a href="#local-6989586621679205603"><span class="hs-identifier hs-var">nameF</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679205600"><span class="hs-identifier hs-var">newBindings</span></a><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679205606"><a href="#local-6989586621679205606"><span class="hs-identifier">adaptorBindings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679205451"><span class="hs-identifier hs-var">processed</span></a><span> </span><span class="hs-operator hs-var">^..</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_3</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span>    </span><span class="hs-comment">-- The final term is a recursive let with the thunkified bindings, surrounding an inner let with the adaptors,</span><span>
</span><a name="line-208"></a><span>    </span><span class="hs-comment">-- and then the body.</span><span>
</span><a name="line-209"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusIR.MkPir.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a><span> </span><a href="#local-6989586621679205433"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="Language.PlutusIR.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a href="#local-6989586621679205601"><span class="hs-identifier hs-var">renamedBindings</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusIR.MkPir.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a><span> </span><a href="#local-6989586621679205433"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="Language.PlutusIR.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621679205606"><span class="hs-identifier hs-var">adaptorBindings</span></a><span> </span><a href="#local-6989586621679205436"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-210"></a></pre></body></html>