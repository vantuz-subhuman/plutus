<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds   #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns      #-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-comment">-- | Functions for compiling GHC types into PlutusCore types, as well as compiling constructors,</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- matchers, and pattern match alternatives.</span><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.PlutusTx.Compiler.Type</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-9"></a><span>    </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>    </span><a href="Language.PlutusTx.Compiler.Kind.html#convKind"><span class="hs-identifier hs-var">convKind</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>    </span><a href="Language.PlutusTx.Compiler.Type.html#getDataCons"><span class="hs-identifier hs-var">getDataCons</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>    </span><a href="Language.PlutusTx.Compiler.Type.html#getConstructors"><span class="hs-identifier hs-var">getConstructors</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>    </span><a href="Language.PlutusTx.Compiler.Type.html#getConstructorsInstantiated"><span class="hs-identifier hs-var">getConstructorsInstantiated</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>    </span><a href="Language.PlutusTx.Compiler.Type.html#getMatch"><span class="hs-identifier hs-var">getMatch</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>    </span><a href="Language.PlutusTx.Compiler.Type.html#getMatchInstantiated"><span class="hs-identifier hs-var">getMatchInstantiated</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>    </span><a href="Language.PlutusTx.Compiler.Type.html#convAlt"><span class="hs-identifier hs-var">convAlt</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>    </span><a href="Language.PlutusTx.Compiler.Type.html#NewtypeCoercion"><span class="hs-identifier hs-type">NewtypeCoercion</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>    </span><a href="Language.PlutusTx.Compiler.Type.html#splitNewtypeCoercion"><span class="hs-identifier hs-var">splitNewtypeCoercion</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Binders.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Binders</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Builtins.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Builtins</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Error.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Error</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Expr</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Kind.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Kind</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Laziness.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Laziness</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Names.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Names</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Types.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Types</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Utils.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Utils</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.PIRTypes.html"><span class="hs-identifier">Language.PlutusTx.PIRTypes</span></a><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GhcPlugins</span><span>                             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Pair</span><span>                                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">PrelNames</span><span>                              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">TysPrim</span><span>                                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusIR</span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PIR</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusIR.Compiler.Definitions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PIR</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.PlutusIR.Compiler.Names</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusIR.MkPir</span><span>                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PIR</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Reader</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List</span><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.List.NonEmpty</span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span>                               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text</span><span>                              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Traversable</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">-- Types</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-identifier">convType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679321792"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679321792"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusTx.PIRTypes.html#PIRType"><span class="hs-identifier hs-type">PIRType</span></a><span>
</span><a name="line-52"></a><a name="convType"><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier">convType</span></a></a><span> </span><a name="local-6989586621679321793"><a href="#local-6989586621679321793"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#withContextM"><span class="hs-identifier hs-var">withContextM</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Utils.html#sdToTxt"><span class="hs-identifier hs-var">sdToTxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Converting type:&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679321793"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-53"></a><span>    </span><span class="hs-comment">-- See Note [Scopes]</span><span>
</span><a name="line-54"></a><span>    </span><a href="Language.PlutusTx.Compiler.Types.html#ConvertingContext"><span class="hs-identifier hs-var">ConvertingContext</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ccScopes</span><span class="hs-glyph">=</span><a name="local-6989586621679321794"><a href="#local-6989586621679321794"><span class="hs-identifier">stack</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679321795"><a href="#local-6989586621679321795"><span class="hs-identifier">top</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NE.head</span><span> </span><a href="#local-6989586621679321794"><span class="hs-identifier hs-var">stack</span></a><span>
</span><a name="line-56"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679321793"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-57"></a><span>        </span><span class="hs-comment">-- in scope type name</span><span>
</span><a name="line-58"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getTyVar_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Names.html#lookupTyName"><span class="hs-identifier hs-var">lookupTyName</span></a><span> </span><a href="#local-6989586621679321795"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PIR.TyVarDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679321796"><a href="#local-6989586621679321796"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.TyVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679321796"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-59"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getTyVar_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679321797"><a href="#local-6989586621679321797"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Utils.html#throwSd"><span class="hs-identifier hs-var">throwSd</span></a><span> </span><a href="Language.PlutusTx.Compiler.Error.html#FreeVariableError"><span class="hs-identifier hs-var">FreeVariableError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Type variable:&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679321797"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-60"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.splitFunTy_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679321798"><a href="#local-6989586621679321798"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679321799"><a href="#local-6989586621679321799"><span class="hs-identifier">o</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">PIR.TyFun</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679321798"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679321799"><span class="hs-identifier hs-var">o</span></a><span>
</span><a name="line-61"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.splitTyConApp_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679321800"><a href="#local-6989586621679321800"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679321801"><a href="#local-6989586621679321801"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convTyConApp"><span class="hs-identifier hs-var">convTyConApp</span></a><span> </span><a href="#local-6989586621679321800"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621679321801"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-62"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.splitForAllTy_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679321802"><a href="#local-6989586621679321802"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679321803"><a href="#local-6989586621679321803"><span class="hs-identifier">tpe</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Binders.html#mkTyForallScoped"><span class="hs-identifier hs-var">mkTyForallScoped</span></a><span> </span><a href="#local-6989586621679321802"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679321803"><span class="hs-identifier hs-var">tpe</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>        </span><span class="hs-comment">-- I think it's safe to ignore the coercion here</span><span>
</span><a name="line-64"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.splitCastTy_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679321804"><a href="#local-6989586621679321804"><span class="hs-identifier">tpe</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679321804"><span class="hs-identifier hs-var">tpe</span></a><span>
</span><a name="line-65"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Utils.html#throwSd"><span class="hs-identifier hs-var">throwSd</span></a><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Type&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679321793"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-identifier">convTyConApp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679321791"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GHC.Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679321791"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusTx.PIRTypes.html#PIRType"><span class="hs-identifier hs-type">PIRType</span></a><span>
</span><a name="line-68"></a><a name="convTyConApp"><a href="Language.PlutusTx.Compiler.Type.html#convTyConApp"><span class="hs-identifier">convTyConApp</span></a></a><span> </span><a name="local-6989586621679321805"><a href="#local-6989586621679321805"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621679321806"><a href="#local-6989586621679321806"><span class="hs-identifier">ts</span></a></a><span>
</span><a name="line-69"></a><span>    </span><span class="hs-comment">-- this is Int#, convert as Int</span><span>
</span><a name="line-70"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679321805"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">GHC.intPrimTyCon</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convTyCon"><span class="hs-identifier hs-var">convTyCon</span></a><span> </span><span class="hs-identifier hs-var">GHC.intTyCon</span><span>
</span><a name="line-71"></a><span>    </span><span class="hs-comment">-- we don't support Integer</span><span>
</span><a name="line-72"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679321805"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">GHC.integerTyConName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-string">&quot;Integer: use Int instead&quot;</span><span>
</span><a name="line-73"></a><span>    </span><span class="hs-comment">-- this is Void#, see Note [Value restriction]</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679321805"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">GHC.voidPrimTyCon</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusTx.Compiler.Builtins.html#errorTy"><span class="hs-identifier hs-var">errorTy</span></a><span>
</span><a name="line-75"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-76"></a><span>        </span><a name="local-6989586621679321807"><a href="#local-6989586621679321807"><span class="hs-identifier">tc'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convTyCon"><span class="hs-identifier hs-var">convTyCon</span></a><span> </span><a href="#local-6989586621679321805"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-77"></a><span>        </span><a name="local-6989586621679321808"><a href="#local-6989586621679321808"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679321806"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-78"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.mkIterTyApp</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679321807"><span class="hs-identifier hs-var">tc'</span></a><span> </span><a href="#local-6989586621679321808"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-identifier">convTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679321790"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679321790"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusTx.PIRTypes.html#PIRType"><span class="hs-identifier hs-type">PIRType</span></a><span>
</span><a name="line-81"></a><a name="convTyCon"><a href="Language.PlutusTx.Compiler.Type.html#convTyCon"><span class="hs-identifier">convTyCon</span></a></a><span> </span><a name="local-6989586621679321809"><a href="#local-6989586621679321809"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-82"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679321810"><a href="#local-6989586621679321810"><span class="hs-identifier">tcName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679321809"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-83"></a><span>    </span><a name="local-6989586621679321811"><a href="#local-6989586621679321811"><span class="hs-identifier">maybeDef</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">PIR.lookupType</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679321810"><span class="hs-identifier hs-var">tcName</span></a><span>
</span><a name="line-84"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679321811"><span class="hs-identifier hs-var">maybeDef</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-85"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679321812"><a href="#local-6989586621679321812"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679321812"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-86"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-87"></a><span>            </span><a name="local-6989586621679321813"><a href="#local-6989586621679321813"><span class="hs-identifier">dcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#getDataCons"><span class="hs-identifier hs-var">getDataCons</span></a><span> </span><a href="#local-6989586621679321809"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-88"></a><span>            </span><a name="local-6989586621679321814"><a href="#local-6989586621679321814"><span class="hs-identifier">usedTcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#getUsedTcs"><span class="hs-identifier hs-var">getUsedTcs</span></a><span> </span><a href="#local-6989586621679321809"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-89"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679321815"><a href="#local-6989586621679321815"><span class="hs-identifier">deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679321814"><span class="hs-identifier hs-var">usedTcs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679321813"><span class="hs-identifier hs-var">dcs</span></a><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span>            </span><a name="local-6989586621679321816"><a href="#local-6989586621679321816"><span class="hs-identifier">tvd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Names.html#convTcTyVarFresh"><span class="hs-identifier hs-var">convTcTyVarFresh</span></a><span> </span><a href="#local-6989586621679321809"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-92"></a><span>            </span><a name="local-6989586621679321817"><a href="#local-6989586621679321817"><span class="hs-identifier">matchName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">safeFreshName</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">GHC.getOccString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679321809"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;_match&quot;</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679321818"><a href="#local-6989586621679321818"><span class="hs-identifier">fakeDatatype</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PIR.Datatype</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679321816"><span class="hs-identifier hs-var">tvd</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679321817"><span class="hs-identifier hs-var">matchName</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-95"></a><span>            </span><span class="hs-identifier hs-var">PIR.defineDatatype</span><span> </span><a href="#local-6989586621679321810"><span class="hs-identifier hs-var">tcName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PIR.Def</span><span> </span><a href="#local-6989586621679321816"><span class="hs-identifier hs-var">tvd</span></a><span> </span><a href="#local-6989586621679321818"><span class="hs-identifier hs-var">fakeDatatype</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span>            </span><span class="hs-comment">-- type variables are in scope for the rest of the definition</span><span>
</span><a name="line-98"></a><span>            </span><a href="Language.PlutusTx.Compiler.Binders.html#withTyVarsScoped"><span class="hs-identifier hs-var">withTyVarsScoped</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">GHC.tyConTyVars</span><span> </span><a href="#local-6989586621679321809"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679321819"><a href="#local-6989586621679321819"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-99"></a><span>                </span><a name="local-6989586621679321823"><a href="#local-6989586621679321823"><span class="hs-identifier">constructors</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">for</span><span> </span><a href="#local-6989586621679321813"><span class="hs-identifier hs-var">dcs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679321820"><a href="#local-6989586621679321820"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-100"></a><span>                    </span><a name="local-6989586621679321821"><a href="#local-6989586621679321821"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Names.html#convNameFresh"><span class="hs-identifier hs-var">convNameFresh</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679321820"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>                    </span><a name="local-6989586621679321822"><a href="#local-6989586621679321822"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#mkConstructorType"><span class="hs-identifier hs-var">mkConstructorType</span></a><span> </span><a href="#local-6989586621679321820"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-102"></a><span>                    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.VarDecl</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679321821"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679321822"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679321824"><a href="#local-6989586621679321824"><span class="hs-identifier">datatype</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PIR.Datatype</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679321816"><span class="hs-identifier hs-var">tvd</span></a><span> </span><a href="#local-6989586621679321819"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621679321817"><span class="hs-identifier hs-var">matchName</span></a><span> </span><a href="#local-6989586621679321823"><span class="hs-identifier hs-var">constructors</span></a><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span>                </span><span class="hs-identifier hs-var">PIR.defineDatatype</span><span> </span><a href="#local-6989586621679321810"><span class="hs-identifier hs-var">tcName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PIR.Def</span><span> </span><a href="#local-6989586621679321816"><span class="hs-identifier hs-var">tvd</span></a><span> </span><a href="#local-6989586621679321824"><span class="hs-identifier hs-var">datatype</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><a href="#local-6989586621679321815"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.mkTyVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679321816"><span class="hs-identifier hs-var">tvd</span></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- Newtypes</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-comment">-- | Wrapper for a pair of types with a direction of wrapping or unwrapping.</span><span>
</span><a name="line-113"></a><span class="hs-keyword">data</span><span> </span><a name="NewtypeCoercion"><a href="Language.PlutusTx.Compiler.Type.html#NewtypeCoercion"><span class="hs-identifier">NewtypeCoercion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Wrap"><a href="Language.PlutusTx.Compiler.Type.html#Wrap"><span class="hs-identifier">Wrap</span></a></a><span> </span><span class="hs-identifier hs-type">GHC.Type</span><span> </span><span class="hs-identifier hs-type">GHC.Type</span><span>
</span><a name="line-114"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a name="Unwrap"><a href="Language.PlutusTx.Compiler.Type.html#Unwrap"><span class="hs-identifier">Unwrap</span></a></a><span> </span><span class="hs-identifier hs-type">GHC.Type</span><span> </span><span class="hs-identifier hs-type">GHC.Type</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-comment">-- | View a 'GHC.Coercion' as possibly a newtype coercion.</span><span>
</span><a name="line-117"></a><span class="hs-identifier">splitNewtypeCoercion</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GHC.Coercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#NewtypeCoercion"><span class="hs-identifier hs-type">NewtypeCoercion</span></a><span>
</span><a name="line-118"></a><a name="splitNewtypeCoercion"><a href="Language.PlutusTx.Compiler.Type.html#splitNewtypeCoercion"><span class="hs-identifier">splitNewtypeCoercion</span></a></a><span> </span><a name="local-6989586621679321825"><a href="#local-6989586621679321825"><span class="hs-identifier">coerce</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">GHC.coercionKind</span><span> </span><a href="#local-6989586621679321825"><span class="hs-identifier hs-var">coerce</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-119"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.Pair</span><span> </span><a name="local-6989586621679322095"><a href="#local-6989586621679322095"><span class="hs-identifier">lhs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.splitTyConApp_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.unwrapNewTyCon_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679322096"><a href="#local-6989586621679322096"><span class="hs-identifier">inner</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679322097"><a href="#local-6989586621679322097"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">GHC.eqType</span><span> </span><a href="#local-6989586621679322097"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621679322096"><span class="hs-identifier hs-var">inner</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#Unwrap"><span class="hs-identifier hs-var">Unwrap</span></a><span> </span><a href="#local-6989586621679322095"><span class="hs-identifier hs-var">lhs</span></a><span> </span><a href="#local-6989586621679322097"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-120"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.Pair</span><span> </span><a name="local-6989586621679322098"><a href="#local-6989586621679322098"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621679322099"><a href="#local-6989586621679322099"><span class="hs-identifier">rhs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.splitTyConApp_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.unwrapNewTyCon_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679322100"><a href="#local-6989586621679322100"><span class="hs-identifier">inner</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">GHC.eqType</span><span> </span><a href="#local-6989586621679322098"><span class="hs-identifier hs-var">lhs</span></a><span> </span><a href="#local-6989586621679322100"><span class="hs-identifier hs-var">inner</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#Wrap"><span class="hs-identifier hs-var">Wrap</span></a><span> </span><a href="#local-6989586621679322098"><span class="hs-identifier hs-var">lhs</span></a><span> </span><a href="#local-6989586621679322099"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-121"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-identifier">getUsedTcs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679321789"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679321789"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GHC.TyCon</span><span class="hs-special">]</span><span>
</span><a name="line-124"></a><a name="getUsedTcs"><a href="Language.PlutusTx.Compiler.Type.html#getUsedTcs"><span class="hs-identifier">getUsedTcs</span></a></a><span> </span><a name="local-6989586621679322101"><a href="#local-6989586621679322101"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-125"></a><span>    </span><a name="local-6989586621679322102"><a href="#local-6989586621679322102"><span class="hs-identifier">dcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#getDataCons"><span class="hs-identifier hs-var">getDataCons</span></a><span> </span><a href="#local-6989586621679322101"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-126"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679322103"><a href="#local-6989586621679322103"><span class="hs-identifier">usedTcs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GHC.unionManyUniqSets</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679322250"><a href="#local-6989586621679322250"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.unionManyUniqSets</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">GHC.tyConsOfType</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.dataConOrigArgTys</span><span> </span><a href="#local-6989586621679322250"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679322102"><span class="hs-identifier hs-var">dcs</span></a><span>
</span><a name="line-127"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">GHC.nonDetEltsUniqSet</span><span> </span><a href="#local-6989586621679322103"><span class="hs-identifier hs-var">usedTcs</span></a><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-comment">{- Note [Case expressions and laziness]
PLC is strict, but users *do* expect that, e.g. they can write an if expression and have it be
lazy. This only *matters* because we have 'error', so it's important that 'if false error else ...'
does not evaluate to 'error'!

More generally, we can compile case expressions (of which an if expression is one) lazily, i.e. we add
a unit argument and apply it at the end.

However, we apply an important optimization: we only need to do this if it is not the case that
all the case expressions are values. In the common case they *will* be, so this gives us
significantly better codegen a lot of the time.

The check we do is:
- Alternatives with arguments will be turned into lambdas by us, so will be values.
- Otherwise, we convert the expression (we can do this easily since it doesn't need any variables in scope),
  and check whether it is a value.

This is somewhat wasteful, since we may convert the expression twice, but it's difficult to avoid, and
it's hard to tell if a GHC core expression will be a PLC value or not. Easiest to just try it.
-}</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-comment">{- Note [Ordering of constructors]
It is very important that we convert types and constructors consistently, especially between
lifting at runtime and compilation via the plugin. The main place we can get bitten is ordering.

GHC is under no obligation to give us any particular ordering of constructors, so we impose
an alphabetical one (with a few exceptions, see [Ensuring compatibility with spec and stdlib types]).

The other place where ordering matters is arguments to constructors, but here there is a
clear natural ordering which we will assume GHC respects.
-}</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span class="hs-comment">{- Note [Ensuring compatibility with spec and stdlib types]
Haskell's Bool has its constructors ordered with False before True, which results in the
normal case expression having the oppposite sense to the one in the spec, where
the true branch comes first (which is more logical).

Our options are:
- Reverse the branches in the spec.
    - This is ugly, the plugin details shouldn't influence the spec.
- Rewrite the primitive functions that produce booleans to produce spec booleans.
    - This is pretty bad codegen.
- Special case Bool to swap the order of the cases.

We take the least bad option, option 3.

The same problem arises for List. It's not in the spec, but the stdlib order (and the natural one)
is nil first and then cons, but &quot;:&quot; is less than &quot;[]&quot;, so we end up with the wrong order. Again,
we just special case this.
-}</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-comment">-- See Note [Ordering of constructors]</span><span>
</span><a name="line-181"></a><span class="hs-identifier">sortConstructors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GHC.TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GHC.DataCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GHC.DataCon</span><span class="hs-special">]</span><span>
</span><a name="line-182"></a><a name="sortConstructors"><a href="Language.PlutusTx.Compiler.Type.html#sortConstructors"><span class="hs-identifier">sortConstructors</span></a></a><span> </span><a name="local-6989586621679322251"><a href="#local-6989586621679322251"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621679322252"><a href="#local-6989586621679322252"><span class="hs-identifier">cs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-183"></a><span>    </span><span class="hs-comment">-- note we compare on the OccName *not* the Name, as the latter compares on uniques, not the string name</span><span>
</span><a name="line-184"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679322253"><a href="#local-6989586621679322253"><span class="hs-identifier">sorted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679322254"><a href="#local-6989586621679322254"><span class="hs-identifier">dc1</span></a></a><span> </span><a name="local-6989586621679322255"><a href="#local-6989586621679322255"><span class="hs-identifier">dc2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getOccName</span><span> </span><a href="#local-6989586621679322254"><span class="hs-identifier hs-var">dc1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getOccName</span><span> </span><a href="#local-6989586621679322255"><span class="hs-identifier hs-var">dc2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679322252"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-185"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679322251"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">GHC.boolTyCon</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679322251"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">GHC.listTyCon</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679322253"><span class="hs-identifier hs-var">sorted</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679322253"><span class="hs-identifier hs-var">sorted</span></a><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-identifier">getDataCons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679321788"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>  </span><span class="hs-identifier hs-type">GHC.TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679321788"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GHC.DataCon</span><span class="hs-special">]</span><span>
</span><a name="line-188"></a><a name="getDataCons"><a href="Language.PlutusTx.Compiler.Type.html#getDataCons"><span class="hs-identifier">getDataCons</span></a></a><span> </span><a name="local-6989586621679322256"><a href="#local-6989586621679322256"><span class="hs-identifier">tc'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#sortConstructors"><span class="hs-identifier hs-var">sortConstructors</span></a><span> </span><a href="#local-6989586621679322256"><span class="hs-identifier hs-var">tc'</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679322257"><span class="hs-identifier hs-var">extractDcs</span></a><span> </span><a href="#local-6989586621679322256"><span class="hs-identifier hs-var">tc'</span></a><span>
</span><a name="line-189"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-190"></a><span>        </span><a name="local-6989586621679322257"><a href="#local-6989586621679322257"><span class="hs-identifier">extractDcs</span></a></a><span> </span><a name="local-6989586621679322258"><a href="#local-6989586621679322258"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-191"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">GHC.isAlgTyCon</span><span> </span><a href="#local-6989586621679322258"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">GHC.isTupleTyCon</span><span> </span><a href="#local-6989586621679322258"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">GHC.algTyConRhs</span><span> </span><a href="#local-6989586621679322258"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-192"></a><span>              </span><span class="hs-identifier hs-var">GHC.AbstractTyCon</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Utils.html#throwSd"><span class="hs-identifier hs-var">throwSd</span></a><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Abstract type:&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679322258"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-193"></a><span>              </span><span class="hs-identifier hs-var">GHC.DataTyCon</span><span class="hs-special">{</span><span class="hs-identifier">GHC.data_cons</span><span class="hs-glyph">=</span><a name="local-6989586621679322259"><a href="#local-6989586621679322259"><span class="hs-identifier">dcs</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679322259"><span class="hs-identifier hs-var">dcs</span></a><span>
</span><a name="line-194"></a><span>              </span><span class="hs-identifier hs-var">GHC.TupleTyCon</span><span class="hs-special">{</span><span class="hs-identifier">GHC.data_con</span><span class="hs-glyph">=</span><a name="local-6989586621679322260"><a href="#local-6989586621679322260"><span class="hs-identifier">dc</span></a></a><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679322260"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">]</span><span>
</span><a name="line-195"></a><span>              </span><span class="hs-identifier hs-var">GHC.SumTyCon</span><span class="hs-special">{</span><span class="hs-identifier">GHC.data_cons</span><span class="hs-glyph">=</span><a name="local-6989586621679322261"><a href="#local-6989586621679322261"><span class="hs-identifier">dcs</span></a></a><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679322261"><span class="hs-identifier hs-var">dcs</span></a><span>
</span><a name="line-196"></a><span>              </span><span class="hs-identifier hs-var">GHC.NewTyCon</span><span class="hs-special">{</span><span class="hs-identifier">GHC.data_con</span><span class="hs-glyph">=</span><a name="local-6989586621679322262"><a href="#local-6989586621679322262"><span class="hs-identifier">dc</span></a></a><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679322262"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">]</span><span>
</span><a name="line-197"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusTx.Compiler.Utils.html#throwSd"><span class="hs-identifier hs-var">throwSd</span></a><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Type constructor:&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679322258"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-comment">-- | Makes the type of the constructor corresponding to the given 'DataCon', with the type variables free.</span><span>
</span><a name="line-200"></a><span class="hs-identifier">mkConstructorType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679321787"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679321787"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusTx.PIRTypes.html#PIRType"><span class="hs-identifier hs-type">PIRType</span></a><span>
</span><a name="line-201"></a><a name="mkConstructorType"><a href="Language.PlutusTx.Compiler.Type.html#mkConstructorType"><span class="hs-identifier">mkConstructorType</span></a></a><span> </span><a name="local-6989586621679322263"><a href="#local-6989586621679322263"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-202"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679322264"><a href="#local-6989586621679322264"><span class="hs-identifier">argTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GHC.dataConOrigArgTys</span><span> </span><a href="#local-6989586621679322263"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-203"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-204"></a><span>        </span><span class="hs-comment">-- See Note [Scott encoding of datatypes]</span><span>
</span><a name="line-205"></a><span>        </span><a href="Language.PlutusTx.Compiler.Error.html#withContextM"><span class="hs-identifier hs-var">withContextM</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Utils.html#sdToTxt"><span class="hs-identifier hs-var">sdToTxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Converting data constructor type:&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679322263"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-206"></a><span>            </span><a name="local-6989586621679322265"><a href="#local-6989586621679322265"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679322264"><span class="hs-identifier hs-var">argTys</span></a><span>
</span><a name="line-207"></a><span>            </span><a name="local-6989586621679322266"><a href="#local-6989586621679322266"><span class="hs-identifier">resultType</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.dataConOrigResTy</span><span> </span><a href="#local-6989586621679322263"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>            </span><span class="hs-comment">-- t_c_i_1 -&gt; ... -&gt; t_c_i_j -&gt; resultType</span><span>
</span><a name="line-209"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.mkIterTyFun</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679322265"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621679322266"><span class="hs-identifier hs-var">resultType</span></a><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-comment">-- | Get the constructors of the given 'TyCon' as PLC terms.</span><span>
</span><a name="line-212"></a><span class="hs-identifier">getConstructors</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679321786"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679321786"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Language.PlutusTx.PIRTypes.html#PIRTerm"><span class="hs-identifier hs-type">PIRTerm</span></a><span class="hs-special">]</span><span>
</span><a name="line-213"></a><a name="getConstructors"><a href="Language.PlutusTx.Compiler.Type.html#getConstructors"><span class="hs-identifier">getConstructors</span></a></a><span> </span><a name="local-6989586621679322267"><a href="#local-6989586621679322267"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-214"></a><span>    </span><span class="hs-comment">-- make sure the constructors have been created</span><span>
</span><a name="line-215"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convTyCon"><span class="hs-identifier hs-var">convTyCon</span></a><span> </span><a href="#local-6989586621679322267"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-216"></a><span>    </span><a name="local-6989586621679322268"><a href="#local-6989586621679322268"><span class="hs-identifier">maybeConstrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">PIR.lookupConstructors</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679322267"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679322268"><span class="hs-identifier hs-var">maybeConstrs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-218"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679322269"><a href="#local-6989586621679322269"><span class="hs-identifier">constrs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679322269"><span class="hs-identifier hs-var">constrs</span></a><span>
</span><a name="line-219"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#ConversionError"><span class="hs-identifier hs-var">ConversionError</span></a><span> </span><span class="hs-string">&quot;Constructors have not been converted&quot;</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span class="hs-comment">-- | Get the constructors of the given 'Type' (which must be equal to a type constructor application) as PLC terms instantiated for</span><span>
</span><a name="line-222"></a><span>    </span><span class="hs-comment">-- the type constructor argument types.</span><span>
</span><a name="line-223"></a><span class="hs-identifier">getConstructorsInstantiated</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679321785"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679321785"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Language.PlutusTx.PIRTypes.html#PIRTerm"><span class="hs-identifier hs-type">PIRTerm</span></a><span class="hs-special">]</span><span>
</span><a name="line-224"></a><a name="getConstructorsInstantiated"><a href="Language.PlutusTx.Compiler.Type.html#getConstructorsInstantiated"><span class="hs-identifier">getConstructorsInstantiated</span></a></a><span> </span><a name="local-6989586621679322270"><a href="#local-6989586621679322270"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#withContextM"><span class="hs-identifier hs-var">withContextM</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Utils.html#sdToTxt"><span class="hs-identifier hs-var">sdToTxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Creating instantiated constructors for type:&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679322270"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679322270"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-225"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.splitTyConApp_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679322271"><a href="#local-6989586621679322271"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679322272"><a href="#local-6989586621679322272"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-226"></a><span>        </span><a name="local-6989586621679322273"><a href="#local-6989586621679322273"><span class="hs-identifier">constrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#getConstructors"><span class="hs-identifier hs-var">getConstructors</span></a><span> </span><a href="#local-6989586621679322271"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span>        </span><span class="hs-identifier hs-var">forM</span><span> </span><a href="#local-6989586621679322273"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679322274"><a href="#local-6989586621679322274"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-229"></a><span>            </span><a name="local-6989586621679322275"><a href="#local-6989586621679322275"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679322272"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-230"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.mkIterInst</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679322274"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679322275"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-231"></a><span>    </span><span class="hs-comment">-- must be a TC app</span><span>
</span><a name="line-232"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#ConversionError"><span class="hs-identifier hs-var">ConversionError</span></a><span> </span><span class="hs-string">&quot;Type was not a type constructor application&quot;</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-comment">-- | Get the matcher of the given 'TyCon' as a PLC term</span><span>
</span><a name="line-235"></a><span class="hs-identifier">getMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679321784"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679321784"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusTx.PIRTypes.html#PIRTerm"><span class="hs-identifier hs-type">PIRTerm</span></a><span>
</span><a name="line-236"></a><a name="getMatch"><a href="Language.PlutusTx.Compiler.Type.html#getMatch"><span class="hs-identifier">getMatch</span></a></a><span> </span><a name="local-6989586621679322276"><a href="#local-6989586621679322276"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-comment">-- ensure the tycon has been converted, which will create the matcher</span><span>
</span><a name="line-238"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convTyCon"><span class="hs-identifier hs-var">convTyCon</span></a><span> </span><a href="#local-6989586621679322276"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-239"></a><span>    </span><a name="local-6989586621679322277"><a href="#local-6989586621679322277"><span class="hs-identifier">maybeMatch</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">PIR.lookupDestructor</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679322276"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679322277"><span class="hs-identifier hs-var">maybeMatch</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-241"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679322278"><a href="#local-6989586621679322278"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679322278"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-242"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#ConversionError"><span class="hs-identifier hs-var">ConversionError</span></a><span> </span><span class="hs-string">&quot;Match has not been converted&quot;</span><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span class="hs-comment">-- | Get the matcher of the given 'Type' (which must be equal to a type constructor application) as a PLC term instantiated for</span><span>
</span><a name="line-245"></a><span class="hs-comment">-- the type constructor argument types.</span><span>
</span><a name="line-246"></a><span class="hs-identifier">getMatchInstantiated</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679321783"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679321783"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusTx.PIRTypes.html#PIRTerm"><span class="hs-identifier hs-type">PIRTerm</span></a><span>
</span><a name="line-247"></a><a name="getMatchInstantiated"><a href="Language.PlutusTx.Compiler.Type.html#getMatchInstantiated"><span class="hs-identifier">getMatchInstantiated</span></a></a><span> </span><a name="local-6989586621679322279"><a href="#local-6989586621679322279"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#withContextM"><span class="hs-identifier hs-var">withContextM</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Utils.html#sdToTxt"><span class="hs-identifier hs-var">sdToTxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Creating instantiated matcher for type:&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679322279"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679322279"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-248"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.splitTyConApp_maybe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679322280"><a href="#local-6989586621679322280"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679322281"><a href="#local-6989586621679322281"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-249"></a><span>        </span><a name="local-6989586621679322282"><a href="#local-6989586621679322282"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#getMatch"><span class="hs-identifier hs-var">getMatch</span></a><span> </span><a href="#local-6989586621679322280"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span>        </span><a name="local-6989586621679322283"><a href="#local-6989586621679322283"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679322281"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-252"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.mkIterInst</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679322282"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621679322283"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-253"></a><span>    </span><span class="hs-comment">-- must be a TC app</span><span>
</span><a name="line-254"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#ConversionError"><span class="hs-identifier hs-var">ConversionError</span></a><span> </span><span class="hs-string">&quot;Type was not a type constructor application&quot;</span><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-comment">-- | Make the alternative for a given 'CoreAlt'.</span><span>
</span><a name="line-257"></a><span class="hs-identifier">convAlt</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679321782"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-259"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- ^ Whether we must delay the alternative.</span><span>
</span><a name="line-260"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GHC.Type</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ The instantiated type arguments for the data constructor.</span><span>
</span><a name="line-261"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.CoreAlt</span><span> </span><span class="hs-comment">-- ^ The 'CoreAlt' representing the branch itself.</span><span>
</span><a name="line-262"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679321782"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusTx.PIRTypes.html#PIRTerm"><span class="hs-identifier hs-type">PIRTerm</span></a><span>
</span><a name="line-263"></a><a name="convAlt"><a href="Language.PlutusTx.Compiler.Type.html#convAlt"><span class="hs-identifier">convAlt</span></a></a><span> </span><a name="local-6989586621679322284"><a href="#local-6989586621679322284"><span class="hs-identifier">mustDelay</span></a></a><span> </span><a name="local-6989586621679322285"><a href="#local-6989586621679322285"><span class="hs-identifier">instArgTys</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679322286"><a href="#local-6989586621679322286"><span class="hs-identifier">alt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679322287"><a href="#local-6989586621679322287"><span class="hs-identifier">vars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679322288"><a href="#local-6989586621679322288"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#withContextM"><span class="hs-identifier hs-var">withContextM</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Utils.html#sdToTxt"><span class="hs-identifier hs-var">sdToTxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Creating alternative:&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679322286"><span class="hs-identifier hs-var">alt</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679322286"><span class="hs-identifier hs-var">alt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-264"></a><span>    </span><span class="hs-identifier hs-var">GHC.LitAlt</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-string">&quot;Literal case&quot;</span><span>
</span><a name="line-265"></a><span>    </span><span class="hs-identifier hs-var">GHC.DEFAULT</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-266"></a><span>        </span><a name="local-6989586621679322289"><a href="#local-6989586621679322289"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679322288"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Language.PlutusTx.Compiler.Laziness.html#maybeDelay"><span class="hs-identifier hs-var">maybeDelay</span></a><span> </span><a href="#local-6989586621679322284"><span class="hs-identifier hs-var">mustDelay</span></a><span>
</span><a name="line-267"></a><span>        </span><span class="hs-comment">-- need to consume the args</span><span>
</span><a name="line-268"></a><span>        </span><a name="local-6989586621679322290"><a href="#local-6989586621679322290"><span class="hs-identifier">argTypes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679322285"><span class="hs-identifier hs-var">instArgTys</span></a><span>
</span><a name="line-269"></a><span>        </span><a name="local-6989586621679322292"><a href="#local-6989586621679322292"><span class="hs-identifier">argNames</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forM</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679322290"><span class="hs-identifier hs-var">argTypes</span></a><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679322291"><a href="#local-6989586621679322291"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">safeFreshName</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;default_arg&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679322291"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-270"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.mkIterLamAbs</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PIR.VarDecl</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679322292"><span class="hs-identifier hs-var">argNames</span></a><span> </span><a href="#local-6989586621679322290"><span class="hs-identifier hs-var">argTypes</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679322289"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-271"></a><span>    </span><span class="hs-comment">-- We just package it up as a lambda bringing all the</span><span>
</span><a name="line-272"></a><span>    </span><span class="hs-comment">-- vars into scope whose body is the body of the case alternative.</span><span>
</span><a name="line-273"></a><span>    </span><span class="hs-comment">-- See Note [Iterated abstraction and application]</span><span>
</span><a name="line-274"></a><span>    </span><span class="hs-comment">-- See Note [Case expressions and laziness]</span><span>
</span><a name="line-275"></a><span>    </span><span class="hs-identifier hs-var">GHC.DataAlt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Binders.html#mkIterLamAbsScoped"><span class="hs-identifier hs-var">mkIterLamAbsScoped</span></a><span> </span><a href="#local-6989586621679322287"><span class="hs-identifier hs-var">vars</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679322288"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Language.PlutusTx.Compiler.Laziness.html#maybeDelay"><span class="hs-identifier hs-var">maybeDelay</span></a><span> </span><a href="#local-6989586621679322284"><span class="hs-identifier hs-var">mustDelay</span></a><span class="hs-special">)</span><span>
</span><a name="line-276"></a></pre></body></html>