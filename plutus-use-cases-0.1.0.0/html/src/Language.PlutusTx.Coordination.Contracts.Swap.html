<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds         #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE NoImplicitPrelude #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards   #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell   #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# OPTIONS_GHC -O0 #-}</span><span>
</span><a name="line-7"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.PlutusTx.Coordination.Contracts.Swap</span><span class="hs-special">(</span><span>
</span><a name="line-8"></a><span>    </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Swap"><span class="hs-identifier hs-type">Swap</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>    </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#swapValidator"><span class="hs-identifier hs-var">swapValidator</span></a><span>
</span><a name="line-10"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusTx</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PlutusTx</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Ledger</span><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Slot</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ValidatorScript</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Value</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Ledger</span><span>                       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Ledger</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Ledger.Validation</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OracleValue</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PendingTx</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PendingTxIn</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PendingTxOut</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Ledger.Validation</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Validation</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Prelude</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Num</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">data</span><span> </span><a name="Ratio"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier">Ratio</span></a></a><span> </span><a name="local-6989586621679257446"><a href="#local-6989586621679257446"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257446"><span class="hs-identifier hs-type">a</span></a><span> </span><a name="%3A%25"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#%3A%25"><span class="hs-operator">:%</span></a></a><span> </span><a href="#local-6989586621679257446"><span class="hs-identifier hs-type">a</span></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Eq</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-comment">-- | A swap is an agreement to exchange cashflows at future dates. To keep</span><span>
</span><a name="line-23"></a><span class="hs-comment">--  things simple, this is an interest rate swap (meaning that the cashflows are</span><span>
</span><a name="line-24"></a><span class="hs-comment">--  interest payments on the same principal amount but with two different</span><span>
</span><a name="line-25"></a><span class="hs-comment">--  interest rates, of which one is fixed and one is floating (varying with</span><span>
</span><a name="line-26"></a><span class="hs-comment">--  time)) with only a single payment date.</span><span>
</span><a name="line-27"></a><span class="hs-comment">--</span><span>
</span><a name="line-28"></a><span class="hs-comment">--  At the beginning of the contract, the fixed rate is set to the expected</span><span>
</span><a name="line-29"></a><span class="hs-comment">--  future value of the floating rate (so if the floating rate behaves as</span><span>
</span><a name="line-30"></a><span class="hs-comment">--  expected, the two payments will be exactly equal).</span><span>
</span><a name="line-31"></a><span class="hs-comment">--</span><span>
</span><a name="line-32"></a><span class="hs-keyword">data</span><span> </span><a name="Swap"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Swap"><span class="hs-identifier">Swap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Swap"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Swap"><span class="hs-identifier">Swap</span></a></a><span>
</span><a name="line-33"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="swapNotionalAmt"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#swapNotionalAmt"><span class="hs-identifier">swapNotionalAmt</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Value</span><span>
</span><a name="line-34"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="swapObservationTime"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#swapObservationTime"><span class="hs-identifier">swapObservationTime</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Slot</span><span>
</span><a name="line-35"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="swapFixedRate"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#swapFixedRate"><span class="hs-identifier">swapFixedRate</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Interest rate fixed at the beginning of the contract</span><span>
</span><a name="line-36"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="swapFloatingRate"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#swapFloatingRate"><span class="hs-identifier">swapFloatingRate</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Interest rate whose value will be observed (by an oracle) on the day of the payment</span><span>
</span><a name="line-37"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="swapMargin"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#swapMargin"><span class="hs-identifier">swapMargin</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Value</span><span> </span><span class="hs-comment">-- ^ Margin deposited at the beginning of the contract to protect against default (one party failing to pay)</span><span>
</span><a name="line-38"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="swapOracle"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#swapOracle"><span class="hs-identifier">swapOracle</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">PubKey</span><span> </span><span class="hs-comment">-- ^ Public key of the oracle (see note [Oracles] in [[Language.PlutusTx.Coordination.Contracts]])</span><span>
</span><a name="line-39"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-comment">-- | Identities of the parties involved in the swap. This will be the data</span><span>
</span><a name="line-42"></a><span class="hs-comment">--   script which allows us to change the identities during the lifetime of</span><span>
</span><a name="line-43"></a><span class="hs-comment">--   the contract (ie. if one of the parties sells their part of the contract)</span><span>
</span><a name="line-44"></a><span class="hs-comment">--</span><span>
</span><a name="line-45"></a><span class="hs-comment">--   In the future we could also put the `swapMargin` value in here to implement</span><span>
</span><a name="line-46"></a><span class="hs-comment">--   a variable margin.</span><span>
</span><a name="line-47"></a><span class="hs-keyword">data</span><span> </span><a name="SwapOwners"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#SwapOwners"><span class="hs-identifier">SwapOwners</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SwapOwners"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#SwapOwners"><span class="hs-identifier">SwapOwners</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-48"></a><span>    </span><a name="swapOwnersFixedLeg"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#swapOwnersFixedLeg"><span class="hs-identifier">swapOwnersFixedLeg</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">PubKey</span><span class="hs-special">,</span><span>
</span><a name="line-49"></a><span>    </span><a name="swapOwnersFloating"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#swapOwnersFloating"><span class="hs-identifier">swapOwnersFloating</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">PubKey</span><span>
</span><a name="line-50"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-keyword">type</span><span> </span><a name="SwapOracle"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#SwapOracle"><span class="hs-identifier">SwapOracle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">OracleValue</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">-- | Validator script for the two transactions that initialise the swap.</span><span>
</span><a name="line-55"></a><span class="hs-comment">--   See note [Swap Transactions]</span><span>
</span><a name="line-56"></a><span class="hs-comment">--   See note [Contracts and Validator Scripts] in</span><span>
</span><a name="line-57"></a><span class="hs-comment">--       Language.Plutus.Coordination.Contracts</span><span>
</span><a name="line-58"></a><span class="hs-identifier">swapValidator</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Swap"><span class="hs-identifier hs-type">Swap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ValidatorScript</span><span>
</span><a name="line-59"></a><a name="swapValidator"><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#swapValidator"><span class="hs-identifier">swapValidator</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ValidatorScript</span><span> </span><a href="#local-6989586621679257447"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-60"></a><span>    </span><a name="local-6989586621679257447"><a href="#local-6989586621679257447"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Ledger.fromCompiledCode</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.compile</span><span> </span><span class="hs-special">[||</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679257449"><a href="#local-6989586621679257449"><span class="hs-identifier">redeemer</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#SwapOracle"><span class="hs-identifier hs-type">SwapOracle</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#SwapOwners"><span class="hs-identifier hs-var">SwapOwners</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679257452"><a href="#local-6989586621679257452"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PendingTx</span><span class="hs-special">)</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Swap"><span class="hs-identifier hs-var">Swap</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-61"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-62"></a><span>            </span><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator">&amp;&amp;</span><span>
</span><a name="line-63"></a><span>            </span><span class="hs-special">(</span><span class="hs-operator">&amp;&amp;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-64"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621679257459"><a href="#local-6989586621679257459"><span class="hs-operator">&amp;&amp;</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.and</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span>            </span><span class="hs-identifier">mn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-67"></a><span>            </span><a name="local-6989586621679257460"><a href="#local-6989586621679257460"><span class="hs-identifier">mn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.min</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span>            </span><span class="hs-identifier">mx</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-70"></a><span>            </span><a name="local-6989586621679257461"><a href="#local-6989586621679257461"><span class="hs-identifier">mx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.max</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span>            </span><span class="hs-identifier">timesR</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-73"></a><span>            </span><a name="local-6989586621679257462"><a href="#local-6989586621679257462"><span class="hs-identifier">timesR</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679257495"><a href="#local-6989586621679257495"><span class="hs-identifier">x</span></a></a><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#%3A%25"><span class="hs-operator hs-var">:%</span></a><span> </span><a name="local-6989586621679257496"><a href="#local-6989586621679257496"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679257497"><a href="#local-6989586621679257497"><span class="hs-identifier">x'</span></a></a><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#%3A%25"><span class="hs-operator hs-var">:%</span></a><span> </span><a name="local-6989586621679257498"><a href="#local-6989586621679257498"><span class="hs-identifier">y'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257495"><span class="hs-identifier hs-var">x</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679257497"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#%3A%25"><span class="hs-operator hs-var">:%</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257496"><span class="hs-identifier hs-var">y</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679257498"><span class="hs-identifier hs-var">y'</span></a><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span>            </span><span class="hs-identifier">plusR</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-76"></a><span>            </span><a name="local-6989586621679257463"><a href="#local-6989586621679257463"><span class="hs-identifier">plusR</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679257499"><a href="#local-6989586621679257499"><span class="hs-identifier">x</span></a></a><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#%3A%25"><span class="hs-operator hs-var">:%</span></a><span> </span><a name="local-6989586621679257500"><a href="#local-6989586621679257500"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679257501"><a href="#local-6989586621679257501"><span class="hs-identifier">x'</span></a></a><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#%3A%25"><span class="hs-operator hs-var">:%</span></a><span> </span><a name="local-6989586621679257502"><a href="#local-6989586621679257502"><span class="hs-identifier">y'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257499"><span class="hs-identifier hs-var">x</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679257502"><span class="hs-identifier hs-var">y'</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679257501"><span class="hs-identifier hs-var">x'</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679257500"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#%3A%25"><span class="hs-operator hs-var">:%</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257500"><span class="hs-identifier hs-var">y</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679257502"><span class="hs-identifier hs-var">y'</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span>            </span><span class="hs-identifier">minusR</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-79"></a><span>            </span><a name="local-6989586621679257464"><a href="#local-6989586621679257464"><span class="hs-identifier">minusR</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679257503"><a href="#local-6989586621679257503"><span class="hs-identifier">x</span></a></a><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#%3A%25"><span class="hs-operator hs-var">:%</span></a><span> </span><a name="local-6989586621679257504"><a href="#local-6989586621679257504"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679257505"><a href="#local-6989586621679257505"><span class="hs-identifier">x'</span></a></a><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#%3A%25"><span class="hs-operator hs-var">:%</span></a><span> </span><a name="local-6989586621679257506"><a href="#local-6989586621679257506"><span class="hs-identifier">y'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257503"><span class="hs-identifier hs-var">x</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679257506"><span class="hs-identifier hs-var">y'</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679257505"><span class="hs-identifier hs-var">x'</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679257504"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#%3A%25"><span class="hs-operator hs-var">:%</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257504"><span class="hs-identifier hs-var">y</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679257506"><span class="hs-identifier hs-var">y'</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span>            </span><span class="hs-identifier">extractVerifyAt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OracleValue</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Slot</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-82"></a><span>            </span><a name="local-6989586621679257465"><a href="#local-6989586621679257465"><span class="hs-identifier">extractVerifyAt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.error</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>            </span><span class="hs-identifier">round</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-85"></a><span>            </span><a name="local-6989586621679257466"><a href="#local-6989586621679257466"><span class="hs-identifier">round</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.error</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span>            </span><span class="hs-comment">-- | Convert an [[Int]] to a [[Ratio Int]]</span><span>
</span><a name="line-88"></a><span>            </span><span class="hs-identifier">fromInt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-89"></a><span>            </span><a name="local-6989586621679257467"><a href="#local-6989586621679257467"><span class="hs-identifier">fromInt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.error</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span>            </span><span class="hs-identifier">signedBy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PendingTxIn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-92"></a><span>            </span><a name="local-6989586621679257468"><a href="#local-6989586621679257468"><span class="hs-identifier">signedBy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">Validation.txInSignedBy</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>            </span><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator">||</span><span>
</span><a name="line-95"></a><span>            </span><span class="hs-special">(</span><span class="hs-operator">||</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-96"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621679257469"><a href="#local-6989586621679257469"><span class="hs-operator">||</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.or</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>            </span><span class="hs-identifier">isPubKeyOutput</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PendingTxOut</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-99"></a><span>            </span><a name="local-6989586621679257470"><a href="#local-6989586621679257470"><span class="hs-identifier">isPubKeyOutput</span></a></a><span> </span><a name="local-6989586621679257512"><a href="#local-6989586621679257512"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621679257513"><a href="#local-6989586621679257513"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.maybe</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">(</span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">Validation.eqPubKey</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679257513"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">Validation.pubKeyOutput</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679257512"><span class="hs-identifier hs-var">o</span></a><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span>            </span><span class="hs-comment">-- Verify the authenticity of the oracle value and compute</span><span>
</span><a name="line-102"></a><span>            </span><span class="hs-comment">-- the payments.</span><span>
</span><a name="line-103"></a><span>            </span><a name="local-6989586621679257471"><a href="#local-6989586621679257471"><span class="hs-identifier">rt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257465"><span class="hs-identifier hs-var">extractVerifyAt</span></a><span> </span><a href="#local-6989586621679257449"><span class="hs-identifier hs-var">redeemer</span></a><span> </span><a href="#local-6989586621679257458"><span class="hs-identifier hs-var">swapOracle</span></a><span> </span><a href="#local-6989586621679257456"><span class="hs-identifier hs-var">swapFloatingRate</span></a><span> </span><a href="#local-6989586621679257454"><span class="hs-identifier hs-var">swapObservationTime</span></a><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span>            </span><span class="hs-identifier">rtDiff</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-106"></a><span>            </span><a name="local-6989586621679257472"><a href="#local-6989586621679257472"><span class="hs-identifier">rtDiff</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257471"><span class="hs-identifier hs-var">rt</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679257464"><span class="hs-identifier hs-var">minusR</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679257455"><span class="hs-identifier hs-var">swapFixedRate</span></a><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span>            </span><a name="local-6989586621679257473"><a href="#local-6989586621679257473"><span class="hs-identifier">amt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679257517"><a href="#local-6989586621679257517"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257453"><span class="hs-identifier hs-var">swapNotionalAmt</span></a><span> </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679257517"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-109"></a><span>            </span><a name="local-6989586621679257474"><a href="#local-6989586621679257474"><span class="hs-identifier">margin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679257518"><a href="#local-6989586621679257518"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257457"><span class="hs-identifier hs-var">swapMargin</span></a><span> </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679257518"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span>            </span><span class="hs-identifier">amt'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-112"></a><span>            </span><a name="local-6989586621679257475"><a href="#local-6989586621679257475"><span class="hs-identifier">amt'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257467"><span class="hs-identifier hs-var">fromInt</span></a><span> </span><a href="#local-6989586621679257473"><span class="hs-identifier hs-var">amt</span></a><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span>            </span><span class="hs-identifier">delta</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Swap.html#Ratio"><span class="hs-identifier hs-type">Ratio</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-115"></a><span>            </span><a name="local-6989586621679257476"><a href="#local-6989586621679257476"><span class="hs-identifier">delta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257475"><span class="hs-identifier hs-var">amt'</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679257462"><span class="hs-identifier hs-var">timesR</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679257472"><span class="hs-identifier hs-var">rtDiff</span></a><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span>            </span><span class="hs-identifier">fixedPayment</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-118"></a><span>            </span><a name="local-6989586621679257477"><a href="#local-6989586621679257477"><span class="hs-identifier">fixedPayment</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257466"><span class="hs-identifier hs-var">round</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257475"><span class="hs-identifier hs-var">amt'</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679257463"><span class="hs-identifier hs-var">plusR</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679257476"><span class="hs-identifier hs-var">delta</span></a><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span>            </span><span class="hs-identifier">floatPayment</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-121"></a><span>            </span><a name="local-6989586621679257478"><a href="#local-6989586621679257478"><span class="hs-identifier">floatPayment</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257466"><span class="hs-identifier hs-var">round</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257475"><span class="hs-identifier hs-var">amt'</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679257463"><span class="hs-identifier hs-var">plusR</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679257476"><span class="hs-identifier hs-var">delta</span></a><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span>            </span><span class="hs-comment">-- Compute the payouts (initial margin +/- the sum of the two</span><span>
</span><a name="line-124"></a><span>            </span><span class="hs-comment">-- payments), ensuring that it is at least 0 and does not exceed</span><span>
</span><a name="line-125"></a><span>            </span><span class="hs-comment">-- the total amount of money at stake (2 * margin)</span><span>
</span><a name="line-126"></a><span>            </span><span class="hs-identifier">clamp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-127"></a><span>            </span><a name="local-6989586621679257479"><a href="#local-6989586621679257479"><span class="hs-identifier">clamp</span></a></a><span> </span><a name="local-6989586621679257519"><a href="#local-6989586621679257519"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257460"><span class="hs-identifier hs-var">mn</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257461"><span class="hs-identifier hs-var">mx</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679257474"><span class="hs-identifier hs-var">margin</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679257519"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>            </span><a name="local-6989586621679257480"><a href="#local-6989586621679257480"><span class="hs-identifier">fixedRemainder</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257479"><span class="hs-identifier hs-var">clamp</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257474"><span class="hs-identifier hs-var">margin</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679257477"><span class="hs-identifier hs-var">fixedPayment</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679257478"><span class="hs-identifier hs-var">floatPayment</span></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>            </span><a name="local-6989586621679257481"><a href="#local-6989586621679257481"><span class="hs-identifier">floatRemainder</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257479"><span class="hs-identifier hs-var">clamp</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257474"><span class="hs-identifier hs-var">margin</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679257478"><span class="hs-identifier hs-var">floatPayment</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679257477"><span class="hs-identifier hs-var">fixedPayment</span></a><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span>            </span><span class="hs-comment">-- The transaction must have one input from each of the</span><span>
</span><a name="line-132"></a><span>            </span><span class="hs-comment">-- participants.</span><span>
</span><a name="line-133"></a><span>            </span><span class="hs-comment">-- NOTE: Partial match is OK because if it fails then the PLC script</span><span>
</span><a name="line-134"></a><span>            </span><span class="hs-comment">--       terminates with `error` and the validation fails (which is</span><span>
</span><a name="line-135"></a><span>            </span><span class="hs-comment">--       what we want when the number of inputs and outputs is /= 2)</span><span>
</span><a name="line-136"></a><span>            </span><span class="hs-identifier hs-var">PendingTx</span><span> </span><span class="hs-special">[</span><a name="local-6989586621679257482"><a href="#local-6989586621679257482"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679257483"><a href="#local-6989586621679257483"><span class="hs-identifier">t2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a name="local-6989586621679257484"><a href="#local-6989586621679257484"><span class="hs-identifier">o1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679257485"><a href="#local-6989586621679257485"><span class="hs-identifier">o2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257452"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span>            </span><span class="hs-comment">-- Each participant must deposit the margin. But we don't know</span><span>
</span><a name="line-139"></a><span>            </span><span class="hs-comment">-- which of the two participant's deposit we are currently</span><span>
</span><a name="line-140"></a><span>            </span><span class="hs-comment">-- evaluating (this script runs on both). So we use the two</span><span>
</span><a name="line-141"></a><span>            </span><span class="hs-comment">-- predicates iP1 and iP2 to cover both cases</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span>            </span><span class="hs-comment">-- True if the transaction input is the margin payment of the</span><span>
</span><a name="line-144"></a><span>            </span><span class="hs-comment">-- fixed leg</span><span>
</span><a name="line-145"></a><span>            </span><span class="hs-identifier">iP1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PendingTxIn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-146"></a><span>            </span><a name="local-6989586621679257486"><a href="#local-6989586621679257486"><span class="hs-identifier">iP1</span></a></a><span> </span><a name="local-6989586621679257520"><a href="#local-6989586621679257520"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">PendingTxIn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679257521"><a href="#local-6989586621679257521"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257468"><span class="hs-identifier hs-var">signedBy</span></a><span> </span><a href="#local-6989586621679257520"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679257450"><span class="hs-identifier hs-var">swapOwnersFixedLeg</span></a><span> </span><a href="#local-6989586621679257459"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679257521"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679257474"><span class="hs-identifier hs-var">margin</span></a><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span>            </span><span class="hs-comment">-- True if the transaction input is the margin payment of the</span><span>
</span><a name="line-149"></a><span>            </span><span class="hs-comment">-- floating leg</span><span>
</span><a name="line-150"></a><span>            </span><span class="hs-identifier">iP2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PendingTxIn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-151"></a><span>            </span><a name="local-6989586621679257487"><a href="#local-6989586621679257487"><span class="hs-identifier">iP2</span></a></a><span> </span><a name="local-6989586621679257522"><a href="#local-6989586621679257522"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">PendingTxIn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679257523"><a href="#local-6989586621679257523"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257468"><span class="hs-identifier hs-var">signedBy</span></a><span> </span><a href="#local-6989586621679257522"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679257451"><span class="hs-identifier hs-var">swapOwnersFloating</span></a><span> </span><a href="#local-6989586621679257459"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679257523"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679257474"><span class="hs-identifier hs-var">margin</span></a><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span>            </span><a name="local-6989586621679257488"><a href="#local-6989586621679257488"><span class="hs-identifier">inConditions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257486"><span class="hs-identifier hs-var">iP1</span></a><span> </span><a href="#local-6989586621679257482"><span class="hs-identifier hs-var">t1</span></a><span>  </span><a href="#local-6989586621679257459"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679257487"><span class="hs-identifier hs-var">iP2</span></a><span> </span><a href="#local-6989586621679257483"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679257469"><span class="hs-operator hs-var">||</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257486"><span class="hs-identifier hs-var">iP1</span></a><span> </span><a href="#local-6989586621679257483"><span class="hs-identifier hs-var">t2</span></a><span> </span><a href="#local-6989586621679257459"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679257487"><span class="hs-identifier hs-var">iP2</span></a><span> </span><a href="#local-6989586621679257482"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span>            </span><span class="hs-comment">-- The transaction must have two outputs, one for each of the</span><span>
</span><a name="line-156"></a><span>            </span><span class="hs-comment">-- participants, which equal the margin adjusted by the difference</span><span>
</span><a name="line-157"></a><span>            </span><span class="hs-comment">-- between fixed and floating payment</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span>            </span><span class="hs-comment">-- True if the output is the payment of the fixed leg.</span><span>
</span><a name="line-160"></a><span>            </span><span class="hs-identifier">ol1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PendingTxOut</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-161"></a><span>            </span><a name="local-6989586621679257489"><a href="#local-6989586621679257489"><span class="hs-identifier">ol1</span></a></a><span> </span><a name="local-6989586621679257524"><a href="#local-6989586621679257524"><span class="hs-identifier">o</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">PendingTxOut</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679257525"><a href="#local-6989586621679257525"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257470"><span class="hs-identifier hs-var">isPubKeyOutput</span></a><span> </span><a href="#local-6989586621679257524"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621679257450"><span class="hs-identifier hs-var">swapOwnersFixedLeg</span></a><span> </span><a href="#local-6989586621679257459"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679257525"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679257480"><span class="hs-identifier hs-var">fixedRemainder</span></a><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span>            </span><span class="hs-comment">-- True if the output is the payment of the floating leg.</span><span>
</span><a name="line-164"></a><span>            </span><span class="hs-identifier">ol2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PendingTxOut</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-165"></a><span>            </span><a name="local-6989586621679257490"><a href="#local-6989586621679257490"><span class="hs-identifier">ol2</span></a></a><span> </span><a name="local-6989586621679257526"><a href="#local-6989586621679257526"><span class="hs-identifier">o</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">PendingTxOut</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679257527"><a href="#local-6989586621679257527"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679257470"><span class="hs-identifier hs-var">isPubKeyOutput</span></a><span> </span><a href="#local-6989586621679257526"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621679257451"><span class="hs-identifier hs-var">swapOwnersFloating</span></a><span> </span><a href="#local-6989586621679257459"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679257527"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679257481"><span class="hs-identifier hs-var">floatRemainder</span></a><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span>            </span><span class="hs-comment">-- NOTE: I didn't include a check that the slot is greater</span><span>
</span><a name="line-168"></a><span>            </span><span class="hs-comment">-- than the observation time. This is because the slot is</span><span>
</span><a name="line-169"></a><span>            </span><span class="hs-comment">-- already part of the oracle value and we trust the oracle.</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span>            </span><a name="local-6989586621679257491"><a href="#local-6989586621679257491"><span class="hs-identifier">outConditions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257489"><span class="hs-identifier hs-var">ol1</span></a><span> </span><a href="#local-6989586621679257484"><span class="hs-identifier hs-var">o1</span></a><span> </span><a href="#local-6989586621679257459"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679257490"><span class="hs-identifier hs-var">ol2</span></a><span> </span><a href="#local-6989586621679257485"><span class="hs-identifier hs-var">o2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679257469"><span class="hs-operator hs-var">||</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679257489"><span class="hs-identifier hs-var">ol1</span></a><span> </span><a href="#local-6989586621679257485"><span class="hs-identifier hs-var">o2</span></a><span> </span><a href="#local-6989586621679257459"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679257490"><span class="hs-identifier hs-var">ol2</span></a><span> </span><a href="#local-6989586621679257484"><span class="hs-identifier hs-var">o1</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span>        </span><span class="hs-keyword">in</span><span>
</span><a name="line-175"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679257488"><span class="hs-identifier hs-var">inConditions</span></a><span> </span><a href="#local-6989586621679257459"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679257491"><span class="hs-identifier hs-var">outConditions</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.error</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>        </span><span class="hs-special">)</span><span> </span><span class="hs-special">||]</span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span class="hs-comment">{- Note [Swap Transactions]

The swap involves three transactions at two different times.

1. At t=0. Each participant deposits the margin. The outputs are locked with
   the same validator script, `swapValidator`
2. At t=n. The value of the floating rate, and consequently the values of the
   two payments are determined. Each participant gets their margin plus or
   minus the actual payment.

There is a risk of losing out if the interest rate moves outside the range of
fixedRate +/- (margin / notional amount). In a real financial contract this
would be dealt with by agreeing a &quot;Variation Margin&quot;. This means that the
margin is adjusted at predefined dates before the actual payment is due. If one
of the parties fails to make the variation margin payment, the contract ends
prematurely and the other party gets to keep both margins.

Plutus should be able to handle variation margins in a series of validation
scripts. But it seems to me that they could get quite messy so I don't want to
write them by hand :) We can probably use TH to generate them at compile time.

-}</span><span>
</span><a name="line-200"></a></pre></body></html>